<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Modeling | Data science in R</title>
  <meta name="description" content="An applied tutorial" />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Modeling | Data science in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="An applied tutorial" />
  <meta name="github-repo" content="ck37/Data-Science-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Modeling | Data science in R" />
  
  <meta name="twitter:description" content="An applied tutorial" />
  



<meta name="date" content="2020-06-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="exploratory-data-analysis.html"/>
<link rel="next" href="calibration.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#rmarkdown-files"><i class="fa fa-check"></i><b>1.1</b> RMarkdown files</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#directory-structure"><i class="fa fa-check"></i><b>1.2</b> Directory structure</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="initial-data-import.html"><a href="initial-data-import.html"><i class="fa fa-check"></i><b>2</b> Initial data import</a><ul>
<li class="chapter" data-level="2.1" data-path="initial-data-import.html"><a href="initial-data-import.html#import-raw-data"><i class="fa fa-check"></i><b>2.1</b> Import raw data</a></li>
<li class="chapter" data-level="2.2" data-path="initial-data-import.html"><a href="initial-data-import.html#merge-data"><i class="fa fa-check"></i><b>2.2</b> Merge data</a></li>
<li class="chapter" data-level="2.3" data-path="initial-data-import.html"><a href="initial-data-import.html#recoding"><i class="fa fa-check"></i><b>2.3</b> Recoding</a></li>
<li class="chapter" data-level="2.4" data-path="initial-data-import.html"><a href="initial-data-import.html#exclusions"><i class="fa fa-check"></i><b>2.4</b> Exclusions</a></li>
<li class="chapter" data-level="2.5" data-path="initial-data-import.html"><a href="initial-data-import.html#categoricals-to-factors"><i class="fa fa-check"></i><b>2.5</b> Categoricals to factors</a></li>
<li class="chapter" data-level="2.6" data-path="initial-data-import.html"><a href="initial-data-import.html#data-structure"><i class="fa fa-check"></i><b>2.6</b> Data structure</a></li>
<li class="chapter" data-level="2.7" data-path="initial-data-import.html"><a href="initial-data-import.html#extreme-value-review"><i class="fa fa-check"></i><b>2.7</b> Extreme value review</a></li>
<li class="chapter" data-level="2.8" data-path="initial-data-import.html"><a href="initial-data-import.html#remove-constant-predictors"><i class="fa fa-check"></i><b>2.8</b> Remove constant predictors</a></li>
<li class="chapter" data-level="2.9" data-path="initial-data-import.html"><a href="initial-data-import.html#tutorial-only-add-random-missingness"><i class="fa fa-check"></i><b>2.9</b> Tutorial-only: add random missingness</a></li>
<li class="chapter" data-level="2.10" data-path="initial-data-import.html"><a href="initial-data-import.html#summarize-predictors"><i class="fa fa-check"></i><b>2.10</b> Summarize predictors</a></li>
<li class="chapter" data-level="" data-path="initial-data-import.html"><a href="initial-data-import.html#save-unimputed-dataset"><i class="fa fa-check"></i>Save unimputed dataset</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html"><i class="fa fa-check"></i><b>3</b> Missing values and imputation</a><ul>
<li class="chapter" data-level="3.1" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#load-data"><i class="fa fa-check"></i><b>3.1</b> Load data</a></li>
<li class="chapter" data-level="3.2" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#examine-predictor-missingness"><i class="fa fa-check"></i><b>3.2</b> Examine predictor missingness</a><ul>
<li class="chapter" data-level="3.2.1" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#missingness-table"><i class="fa fa-check"></i><b>3.2.1</b> Missingness table</a></li>
<li class="chapter" data-level="3.2.2" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#missingness-heatmap"><i class="fa fa-check"></i><b>3.2.2</b> Missingness heatmap</a></li>
<li class="chapter" data-level="3.2.3" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#missingness-count-plot"><i class="fa fa-check"></i><b>3.2.3</b> Missingness count plot</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#examine-outcome-missingness"><i class="fa fa-check"></i><b>3.3</b> Examine outcome missingness</a></li>
<li class="chapter" data-level="3.4" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#impute-missing-predictor-values"><i class="fa fa-check"></i><b>3.4</b> Impute missing predictor values</a><ul>
<li class="chapter" data-level="3.4.1" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#missingness-indicators"><i class="fa fa-check"></i><b>3.4.1</b> Missingness indicators</a></li>
<li class="chapter" data-level="3.4.2" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#impute-to-0"><i class="fa fa-check"></i><b>3.4.2</b> Impute to 0</a></li>
<li class="chapter" data-level="3.4.3" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#glrm-prep"><i class="fa fa-check"></i><b>3.4.3</b> GLRM prep</a></li>
<li class="chapter" data-level="3.4.4" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#start-h2o"><i class="fa fa-check"></i><b>3.4.4</b> Start h2o</a></li>
<li class="chapter" data-level="3.4.5" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#load-data-into-h2o"><i class="fa fa-check"></i><b>3.4.5</b> Load data into h2o</a></li>
<li class="chapter" data-level="3.4.6" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#glrm-traintest-split"><i class="fa fa-check"></i><b>3.4.6</b> GLRM train/test split</a></li>
<li class="chapter" data-level="3.4.7" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#define-glrm-grid"><i class="fa fa-check"></i><b>3.4.7</b> Define GLRM grid</a></li>
<li class="chapter" data-level="3.4.8" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#glrm-grid-search"><i class="fa fa-check"></i><b>3.4.8</b> GLRM grid search</a></li>
<li class="chapter" data-level="3.4.9" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#apply-best-glrm"><i class="fa fa-check"></i><b>3.4.9</b> Apply best GLRM</a></li>
<li class="chapter" data-level="3.4.10" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#review-glrm"><i class="fa fa-check"></i><b>3.4.10</b> Review GLRM</a></li>
<li class="chapter" data-level="3.4.11" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#evaluate-imputation"><i class="fa fa-check"></i><b>3.4.11</b> Evaluate imputation</a></li>
<li class="chapter" data-level="3.4.12" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#replace-missing-values."><i class="fa fa-check"></i><b>3.4.12</b> Replace missing values.</a></li>
<li class="chapter" data-level="3.4.13" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#shutdown-h2o"><i class="fa fa-check"></i><b>3.4.13</b> Shutdown h2o</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#update-predictor-summary"><i class="fa fa-check"></i><b>3.5</b> Update predictor summary</a></li>
<li class="chapter" data-level="3.6" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#histogram-condense"><i class="fa fa-check"></i><b>3.6</b> Histogram condense</a></li>
<li class="chapter" data-level="3.7" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#update-predictor-summary-1"><i class="fa fa-check"></i><b>3.7</b> Update predictor summary</a></li>
<li class="chapter" data-level="" data-path="missing-values-and-imputation.html"><a href="missing-values-and-imputation.html#save-imputed-dataset"><i class="fa fa-check"></i>Save imputed dataset</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="dataset-finalization.html"><a href="dataset-finalization.html"><i class="fa fa-check"></i><b>4</b> Dataset finalization</a><ul>
<li class="chapter" data-level="" data-path="dataset-finalization.html"><a href="dataset-finalization.html#load-data-1"><i class="fa fa-check"></i>Load data</a></li>
<li class="chapter" data-level="4.1" data-path="dataset-finalization.html"><a href="dataset-finalization.html#factors-to-indicators"><i class="fa fa-check"></i><b>4.1</b> Factors to indicators</a></li>
<li class="chapter" data-level="4.2" data-path="dataset-finalization.html"><a href="dataset-finalization.html#remove-collinear-predictors"><i class="fa fa-check"></i><b>4.2</b> Remove collinear predictors</a></li>
<li class="chapter" data-level="4.3" data-path="dataset-finalization.html"><a href="dataset-finalization.html#confirm-predictor-matrix-invertability"><i class="fa fa-check"></i><b>4.3</b> Confirm predictor matrix invertability</a></li>
<li class="chapter" data-level="" data-path="dataset-finalization.html"><a href="dataset-finalization.html#save-finalized-dataset"><i class="fa fa-check"></i>Save finalized dataset</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html"><i class="fa fa-check"></i><b>5</b> Exploratory data analysis</a><ul>
<li class="chapter" data-level="" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#load-data-2"><i class="fa fa-check"></i>Load data</a></li>
<li class="chapter" data-level="" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#tbd"><i class="fa fa-check"></i>TBD</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>6</b> Modeling</a><ul>
<li class="chapter" data-level="" data-path="modeling.html"><a href="modeling.html#load-data-3"><i class="fa fa-check"></i>Load data</a></li>
<li class="chapter" data-level="6.1" data-path="modeling.html"><a href="modeling.html#random-forest"><i class="fa fa-check"></i><b>6.1</b> Random forest</a><ul>
<li class="chapter" data-level="6.1.1" data-path="modeling.html"><a href="modeling.html#rf-convergence-plot"><i class="fa fa-check"></i><b>6.1.1</b> RF convergence plot</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="modeling.html"><a href="modeling.html#ensemble"><i class="fa fa-check"></i><b>6.2</b> Ensemble</a><ul>
<li class="chapter" data-level="6.2.1" data-path="modeling.html"><a href="modeling.html#prep-sl-library"><i class="fa fa-check"></i><b>6.2.1</b> Prep SL library</a></li>
<li class="chapter" data-level="6.2.2" data-path="modeling.html"><a href="modeling.html#estimate-superlearner"><i class="fa fa-check"></i><b>6.2.2</b> Estimate SuperLearner</a></li>
<li class="chapter" data-level="6.2.3" data-path="modeling.html"><a href="modeling.html#review-sl-results"><i class="fa fa-check"></i><b>6.2.3</b> Review SL results</a></li>
<li class="chapter" data-level="6.2.4" data-path="modeling.html"><a href="modeling.html#sl-pr-auc"><i class="fa fa-check"></i><b>6.2.4</b> SL PR-AUC</a></li>
<li class="chapter" data-level="6.2.5" data-path="modeling.html"><a href="modeling.html#sl-plots"><i class="fa fa-check"></i><b>6.2.5</b> SL plots</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="modeling.html"><a href="modeling.html#nested-ensemble"><i class="fa fa-check"></i><b>6.3</b> Nested ensemble</a><ul>
<li class="chapter" data-level="6.3.1" data-path="modeling.html"><a href="modeling.html#ensemble-weights"><i class="fa fa-check"></i><b>6.3.1</b> Ensemble weights</a></li>
<li class="chapter" data-level="6.3.2" data-path="modeling.html"><a href="modeling.html#auc-analysis"><i class="fa fa-check"></i><b>6.3.2</b> AUC analysis</a></li>
<li class="chapter" data-level="6.3.3" data-path="modeling.html"><a href="modeling.html#precision-recall-analysis"><i class="fa fa-check"></i><b>6.3.3</b> Precision-Recall analysis</a></li>
<li class="chapter" data-level="6.3.4" data-path="modeling.html"><a href="modeling.html#brier-score"><i class="fa fa-check"></i><b>6.3.4</b> Brier score</a></li>
<li class="chapter" data-level="6.3.5" data-path="modeling.html"><a href="modeling.html#index-of-prediction-accuracy"><i class="fa fa-check"></i><b>6.3.5</b> Index of prediction accuracy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="calibration.html"><a href="calibration.html"><i class="fa fa-check"></i><b>7</b> Calibration</a><ul>
<li class="chapter" data-level="" data-path="calibration.html"><a href="calibration.html#tbd-1"><i class="fa fa-check"></i>TBD</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="interpretation.html"><a href="interpretation.html"><i class="fa fa-check"></i><b>8</b> Interpretation</a><ul>
<li class="chapter" data-level="" data-path="interpretation.html"><a href="interpretation.html#load-data-4"><i class="fa fa-check"></i>Load data</a></li>
<li class="chapter" data-level="8.1" data-path="interpretation.html"><a href="interpretation.html#variable-importance"><i class="fa fa-check"></i><b>8.1</b> Variable importance</a><ul>
<li class="chapter" data-level="8.1.1" data-path="interpretation.html"><a href="interpretation.html#random-forest-1"><i class="fa fa-check"></i><b>8.1.1</b> Random forest</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="interpretation.html"><a href="interpretation.html#accumulated-local-effect-plots"><i class="fa fa-check"></i><b>8.2</b> Accumulated local effect plots</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data science in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="modeling" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Modeling</h1>
<div id="load-data-3" class="section level2 unnumbered">
<h2>Load data</h2>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="modeling.html#cb256-1"></a><span class="co"># Created in 3-clean-finalize.Rmd</span></span>
<span id="cb256-2"><a href="modeling.html#cb256-2"></a><span class="co"># Objects included: data, vars, var_df</span></span>
<span id="cb256-3"><a href="modeling.html#cb256-3"></a><span class="co"># renv also includes a load() method, so we specify base:: here.</span></span>
<span id="cb256-4"><a href="modeling.html#cb256-4"></a>base<span class="op">::</span><span class="kw">load</span>(<span class="st">&quot;data/clean-finalize-imputed.RData&quot;</span>)</span></code></pre></div>
</div>
<div id="random-forest" class="section level2">
<h2><span class="header-section-number">6.1</span> Random forest</h2>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="modeling.html#cb257-1"></a><span class="kw">set.seed</span>(<span class="dv">1</span>, <span class="st">&quot;L&#39;Ecuyer-CMRG&quot;</span>)</span>
<span id="cb257-2"><a href="modeling.html#cb257-2"></a></span>
<span id="cb257-3"><a href="modeling.html#cb257-3"></a><span class="co"># mlr wants covariates and outcome to be in the same dataframe.</span></span>
<span id="cb257-4"><a href="modeling.html#cb257-4"></a></span>
<span id="cb257-5"><a href="modeling.html#cb257-5"></a><span class="co"># For classification RF needs Y to be a factor.</span></span>
<span id="cb257-6"><a href="modeling.html#cb257-6"></a><span class="co"># We use the best mtry based on the CV.SL results from the final prediction library.</span></span>
<span id="cb257-7"><a href="modeling.html#cb257-7"></a><span class="co"># Takes 1 second.</span></span>
<span id="cb257-8"><a href="modeling.html#cb257-8"></a>(<span class="dt">rf_time =</span> <span class="kw">system.time</span>({</span>
<span id="cb257-9"><a href="modeling.html#cb257-9"></a>  <span class="co"># Ranger uses all available threads by default, nice.</span></span>
<span id="cb257-10"><a href="modeling.html#cb257-10"></a>  y =<span class="st"> </span><span class="kw">as.factor</span>(data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]]) </span>
<span id="cb257-11"><a href="modeling.html#cb257-11"></a>  rf =<span class="st"> </span>ranger<span class="op">::</span><span class="kw">ranger</span>(y <span class="op">~</span><span class="st"> </span>. ,</span>
<span id="cb257-12"><a href="modeling.html#cb257-12"></a>                      <span class="dt">data =</span> data[, vars<span class="op">$</span>predictors],</span>
<span id="cb257-13"><a href="modeling.html#cb257-13"></a>                      <span class="dt">num.threads =</span> <span class="kw">get_cores</span>(),</span>
<span id="cb257-14"><a href="modeling.html#cb257-14"></a>                      <span class="co"># Need this option for OOB curve analysis.</span></span>
<span id="cb257-15"><a href="modeling.html#cb257-15"></a>                      <span class="dt">keep.inbag =</span> <span class="ot">TRUE</span>,</span>
<span id="cb257-16"><a href="modeling.html#cb257-16"></a>                      <span class="dt">num.trees =</span> <span class="dv">4000</span>,</span>
<span id="cb257-17"><a href="modeling.html#cb257-17"></a>                      <span class="co"># Could also do importance = &quot;impurity&quot;.</span></span>
<span id="cb257-18"><a href="modeling.html#cb257-18"></a>                      <span class="dt">importance =</span> <span class="st">&quot;permutation&quot;</span>,</span>
<span id="cb257-19"><a href="modeling.html#cb257-19"></a>                      <span class="co"># Set based on separate grid/random search.</span></span>
<span id="cb257-20"><a href="modeling.html#cb257-20"></a>                      <span class="dt">mtry =</span> 4L,</span>
<span id="cb257-21"><a href="modeling.html#cb257-21"></a>                      <span class="co"># Set based on separate grid/random search.</span></span>
<span id="cb257-22"><a href="modeling.html#cb257-22"></a>                      <span class="dt">min.node.size =</span> 5L)</span>
<span id="cb257-23"><a href="modeling.html#cb257-23"></a>}))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##    1.92    0.17    0.78</code></pre>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="modeling.html#cb259-1"></a><span class="kw">save</span>(rf, <span class="dt">file =</span> <span class="st">&quot;data/model-rf.RData&quot;</span>)</span></code></pre></div>
<div id="rf-convergence-plot" class="section level3">
<h3><span class="header-section-number">6.1.1</span> RF convergence plot</h3>
<p>The results of this block are cached because they are slow to compute.</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="modeling.html#cb260-1"></a><span class="kw">library</span>(mlr)</span>
<span id="cb260-2"><a href="modeling.html#cb260-2"></a><span class="kw">library</span>(OOBCurve)</span>
<span id="cb260-3"><a href="modeling.html#cb260-3"></a></span>
<span id="cb260-4"><a href="modeling.html#cb260-4"></a>oob_data =<span class="st"> </span>data[, <span class="kw">c</span>(vars<span class="op">$</span>outcomes[<span class="dv">1</span>], vars<span class="op">$</span>predictors), drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb260-5"><a href="modeling.html#cb260-5"></a></span>
<span id="cb260-6"><a href="modeling.html#cb260-6"></a><span class="co"># Outcome needs to be a factor.</span></span>
<span id="cb260-7"><a href="modeling.html#cb260-7"></a>oob_data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]] =<span class="st"> </span><span class="kw">as.factor</span>(data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]])</span>
<span id="cb260-8"><a href="modeling.html#cb260-8"></a></span>
<span id="cb260-9"><a href="modeling.html#cb260-9"></a></span>
<span id="cb260-10"><a href="modeling.html#cb260-10"></a>task =<span class="st"> </span><span class="kw">makeClassifTask</span>(<span class="dt">data =</span> oob_data, <span class="dt">target =</span> vars<span class="op">$</span>outcomes[<span class="dv">1</span>])</span>
<span id="cb260-11"><a href="modeling.html#cb260-11"></a><span class="co"># Current package has a bug such that multiple measures have to be specified.</span></span>
<span id="cb260-12"><a href="modeling.html#cb260-12"></a><span class="co"># We aren&#39;t using the Brier score though.</span></span>
<span id="cb260-13"><a href="modeling.html#cb260-13"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: these results could be averaged over multiple random shufflings</span></span>
<span id="cb260-14"><a href="modeling.html#cb260-14"></a><span class="co"># of the tree ordering. Would give a more accurate, smoother curve.</span></span>
<span id="cb260-15"><a href="modeling.html#cb260-15"></a><span class="co"># This takes ~10 seconds.</span></span>
<span id="cb260-16"><a href="modeling.html#cb260-16"></a><span class="kw">system.time</span>({</span>
<span id="cb260-17"><a href="modeling.html#cb260-17"></a>  results =<span class="st"> </span><span class="kw">OOBCurve</span>(rf, <span class="dt">measures =</span> <span class="kw">list</span>(mlr<span class="op">::</span>auc, mlr<span class="op">::</span>brier), <span class="dt">task =</span> task,</span>
<span id="cb260-18"><a href="modeling.html#cb260-18"></a>                     <span class="dt">data =</span> oob_data)</span>
<span id="cb260-19"><a href="modeling.html#cb260-19"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##    9.80    0.11   10.18</code></pre>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="modeling.html#cb262-1"></a><span class="co"># Look at the OOB AUC with the maximum number of trees.</span></span>
<span id="cb262-2"><a href="modeling.html#cb262-2"></a><span class="co"># 0.894</span></span>
<span id="cb262-3"><a href="modeling.html#cb262-3"></a>(<span class="dt">rf_auc =</span> results<span class="op">$</span>auc[<span class="kw">length</span>(results<span class="op">$</span>auc)])</span></code></pre></div>
<pre><code>## [1] 0.8972771</code></pre>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="modeling.html#cb264-1"></a><span class="co"># Can zoom in to certain segments of the forest indexed by an ntree range.</span></span>
<span id="cb264-2"><a href="modeling.html#cb264-2"></a>tree_start =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb264-3"><a href="modeling.html#cb264-3"></a><span class="co">#tree_start = 10</span></span>
<span id="cb264-4"><a href="modeling.html#cb264-4"></a>tree_end =<span class="st"> </span><span class="kw">length</span>(results<span class="op">$</span>auc)</span>
<span id="cb264-5"><a href="modeling.html#cb264-5"></a>x_span =<span class="st"> </span><span class="kw">seq</span>(tree_start, tree_end)</span>
<span id="cb264-6"><a href="modeling.html#cb264-6"></a>y_span =<span class="st"> </span>results<span class="op">$</span>auc[x_span]</span>
<span id="cb264-7"><a href="modeling.html#cb264-7"></a></span>
<span id="cb264-8"><a href="modeling.html#cb264-8"></a><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> x_span, <span class="dt">y =</span> y_span)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb264-9"><a href="modeling.html#cb264-9"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">ratio =</span> <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb264-10"><a href="modeling.html#cb264-10"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="fl">0.5</span>, <span class="fl">0.94</span>)) <span class="op">+</span></span>
<span id="cb264-11"><a href="modeling.html#cb264-11"></a><span class="st">  </span><span class="kw">scale_x_log10</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">100</span>, <span class="dv">300</span>, <span class="dv">1000</span>, <span class="dv">3000</span>),</span>
<span id="cb264-12"><a href="modeling.html#cb264-12"></a>                <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4000</span>),</span>
<span id="cb264-13"><a href="modeling.html#cb264-13"></a>                <span class="dt">minor_breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb264-14"><a href="modeling.html#cb264-14"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Trees in the random forest&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Out of Bag AUC&quot;</span>)</span></code></pre></div>
<p><img src="data-science-in-r_files/figure-html/rf_oob_curve-1.png" width="672" /></p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="modeling.html#cb265-1"></a><span class="kw">ggsave</span>(<span class="st">&quot;visuals/rf-error-rate-by-trees.pdf&quot;</span>,</span>
<span id="cb265-2"><a href="modeling.html#cb265-2"></a>       <span class="dt">width =</span> <span class="dv">7</span>, <span class="dt">height =</span> <span class="dv">3</span>)</span></code></pre></div>
</div>
</div>
<div id="ensemble" class="section level2">
<h2><span class="header-section-number">6.2</span> Ensemble</h2>
<div id="prep-sl-library" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Prep SL library</h3>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="modeling.html#cb266-1"></a><span class="co"># Via R/sl-dbarts2.R</span></span>
<span id="cb266-2"><a href="modeling.html#cb266-2"></a>SL.dbarts =<span class="st"> </span>SL.dbarts2</span>
<span id="cb266-3"><a href="modeling.html#cb266-3"></a></span>
<span id="cb266-4"><a href="modeling.html#cb266-4"></a><span class="co"># We aren&#39;t using this grid.</span></span>
<span id="cb266-5"><a href="modeling.html#cb266-5"></a>learner_bart =</span>
<span id="cb266-6"><a href="modeling.html#cb266-6"></a><span class="st">  </span><span class="kw">create.Learner</span>(<span class="st">&quot;SL.dbarts&quot;</span>,</span>
<span id="cb266-7"><a href="modeling.html#cb266-7"></a>                 <span class="co"># Turning off detailed_names because binary_offset has a negative value.</span></span>
<span id="cb266-8"><a href="modeling.html#cb266-8"></a>                 <span class="co">#detailed_names = FALSE,</span></span>
<span id="cb266-9"><a href="modeling.html#cb266-9"></a>                 <span class="dt">detailed_names =</span> <span class="ot">TRUE</span>,</span>
<span id="cb266-10"><a href="modeling.html#cb266-10"></a>                 <span class="dt">params =</span> <span class="kw">list</span>(<span class="dt">nthread =</span> <span class="kw">getOption</span>(<span class="st">&quot;cores&quot;</span>)),</span>
<span id="cb266-11"><a href="modeling.html#cb266-11"></a>                 <span class="dt">tune =</span> <span class="kw">list</span>(<span class="dt">ntree =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">500</span>)))<span class="co">#,</span></span>
<span id="cb266-12"><a href="modeling.html#cb266-12"></a></span>
<span id="cb266-13"><a href="modeling.html#cb266-13"></a>screen_names =<span class="st"> </span><span class="cf">function</span>(Y, X, <span class="dt">names =</span> <span class="kw">names</span>(X), ...)  {</span>
<span id="cb266-14"><a href="modeling.html#cb266-14"></a>    <span class="kw">return</span>(<span class="kw">names</span>(X) <span class="op">%in%</span><span class="st"> </span>names)</span>
<span id="cb266-15"><a href="modeling.html#cb266-15"></a>}</span>
<span id="cb266-16"><a href="modeling.html#cb266-16"></a></span>
<span id="cb266-17"><a href="modeling.html#cb266-17"></a></span>
<span id="cb266-18"><a href="modeling.html#cb266-18"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: add feature selection options (BART, lasso, RF)</span></span>
<span id="cb266-19"><a href="modeling.html#cb266-19"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: explore optimization of the meta-learner step.</span></span>
<span id="cb266-20"><a href="modeling.html#cb266-20"></a>xgb_tune =<span class="st"> </span><span class="cf">function</span>(Y, X, newX, family, obsWeights, id, ...) {</span>
<span id="cb266-21"><a href="modeling.html#cb266-21"></a>  <span class="kw">cat</span>(<span class="st">&quot;Running xgb_tune</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb266-22"><a href="modeling.html#cb266-22"></a>  </span>
<span id="cb266-23"><a href="modeling.html#cb266-23"></a>  <span class="co"># Create tuning grid.</span></span>
<span id="cb266-24"><a href="modeling.html#cb266-24"></a>  grid =<span class="st"> </span><span class="kw">create.Learner</span>(<span class="st">&quot;SL.xgboost_fast&quot;</span>, <span class="dt">detailed_names =</span> <span class="ot">TRUE</span>, </span>
<span id="cb266-25"><a href="modeling.html#cb266-25"></a>                        <span class="dt">tune =</span> <span class="kw">list</span>(</span>
<span id="cb266-26"><a href="modeling.html#cb266-26"></a>                          <span class="co"># 27 combos.</span></span>
<span id="cb266-27"><a href="modeling.html#cb266-27"></a>                          <span class="dt">ntrees =</span> <span class="kw">c</span>(100L, 300L, 1000L),</span>
<span id="cb266-28"><a href="modeling.html#cb266-28"></a>                          <span class="dt">max_depth =</span> <span class="kw">c</span>(1L, 3L, 6L),</span>
<span id="cb266-29"><a href="modeling.html#cb266-29"></a>                          <span class="dt">shrinkage =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>)))</span>
<span id="cb266-30"><a href="modeling.html#cb266-30"></a>  </span>
<span id="cb266-31"><a href="modeling.html#cb266-31"></a>  <span class="co"># Coarser/faster grid.</span></span>
<span id="cb266-32"><a href="modeling.html#cb266-32"></a>  grid2 =<span class="st"> </span><span class="kw">create.Learner</span>(<span class="st">&quot;SL.xgboost_fast&quot;</span>, <span class="dt">detailed_names =</span> <span class="ot">TRUE</span>, </span>
<span id="cb266-33"><a href="modeling.html#cb266-33"></a>                        <span class="dt">tune =</span> <span class="kw">list</span>(</span>
<span id="cb266-34"><a href="modeling.html#cb266-34"></a>                          <span class="co"># 8 combos.</span></span>
<span id="cb266-35"><a href="modeling.html#cb266-35"></a>                          <span class="dt">ntrees =</span> <span class="kw">c</span>(250L, 1000L),</span>
<span id="cb266-36"><a href="modeling.html#cb266-36"></a>                          <span class="dt">max_depth =</span> <span class="kw">c</span>(2L, 4L),</span>
<span id="cb266-37"><a href="modeling.html#cb266-37"></a>                          <span class="dt">shrinkage =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.2</span>)))</span>
<span id="cb266-38"><a href="modeling.html#cb266-38"></a>  </span>
<span id="cb266-39"><a href="modeling.html#cb266-39"></a>  <span class="co"># Run SuperLearner.</span></span>
<span id="cb266-40"><a href="modeling.html#cb266-40"></a>  <span class="co"># id argument is not being passed to avoid an error &quot;stratified sampling with id not currently implemented&quot;</span></span>
<span id="cb266-41"><a href="modeling.html#cb266-41"></a>  sl =<span class="st"> </span><span class="kw">SuperLearner</span>(<span class="dt">Y =</span> Y, <span class="dt">X =</span> X, <span class="dt">newX =</span> newX, <span class="dt">obsWeights =</span> obsWeights, <span class="dt">family =</span> family,</span>
<span id="cb266-42"><a href="modeling.html#cb266-42"></a>                    <span class="dt">SL.library =</span> grid2<span class="op">$</span>names,</span>
<span id="cb266-43"><a href="modeling.html#cb266-43"></a>                    <span class="dt">cvControl =</span> <span class="kw">SuperLearner.CV.control</span>(<span class="dt">stratifyCV =</span> <span class="ot">TRUE</span>,</span>
<span id="cb266-44"><a href="modeling.html#cb266-44"></a>                                                        <span class="co"># Set to 2 for tutorial.</span></span>
<span id="cb266-45"><a href="modeling.html#cb266-45"></a>                                                        <span class="dt">V =</span> 2L),</span>
<span id="cb266-46"><a href="modeling.html#cb266-46"></a>                                                        <span class="co">#V = 5L),</span></span>
<span id="cb266-47"><a href="modeling.html#cb266-47"></a>                    <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb266-48"><a href="modeling.html#cb266-48"></a>  </span>
<span id="cb266-49"><a href="modeling.html#cb266-49"></a>  <span class="kw">cat</span>(<span class="st">&quot;XGB tuned SL:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb266-50"><a href="modeling.html#cb266-50"></a>  <span class="kw">print</span>(sl)</span>
<span id="cb266-51"><a href="modeling.html#cb266-51"></a>  </span>
<span id="cb266-52"><a href="modeling.html#cb266-52"></a>  <span class="co"># fit returns all objects needed for predict()</span></span>
<span id="cb266-53"><a href="modeling.html#cb266-53"></a>  fit =<span class="st"> </span><span class="kw">list</span>(<span class="dt">object =</span> sl)</span>
<span id="cb266-54"><a href="modeling.html#cb266-54"></a>  </span>
<span id="cb266-55"><a href="modeling.html#cb266-55"></a>  <span class="co"># Declare class of fit for predict()</span></span>
<span id="cb266-56"><a href="modeling.html#cb266-56"></a>  <span class="kw">class</span>(fit) =<span class="st"> &#39;SuperLearner&#39;</span></span>
<span id="cb266-57"><a href="modeling.html#cb266-57"></a>  </span>
<span id="cb266-58"><a href="modeling.html#cb266-58"></a>  out =<span class="st"> </span><span class="kw">list</span>(<span class="dt">pred =</span> sl<span class="op">$</span>SL.predict, <span class="dt">fit =</span> fit)</span>
<span id="cb266-59"><a href="modeling.html#cb266-59"></a>  <span class="kw">return</span>(out)</span>
<span id="cb266-60"><a href="modeling.html#cb266-60"></a>}</span>
<span id="cb266-61"><a href="modeling.html#cb266-61"></a></span>
<span id="cb266-62"><a href="modeling.html#cb266-62"></a>rf_tune =<span class="st"> </span><span class="cf">function</span>(Y, X, newX, family, obsWeights, id, ...) {</span>
<span id="cb266-63"><a href="modeling.html#cb266-63"></a>  <span class="kw">cat</span>(<span class="st">&quot;Running rf_tune</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb266-64"><a href="modeling.html#cb266-64"></a>  </span>
<span id="cb266-65"><a href="modeling.html#cb266-65"></a>  <span class="co"># Create tuning grid.</span></span>
<span id="cb266-66"><a href="modeling.html#cb266-66"></a>  grid =<span class="st"> </span><span class="kw">create.Learner</span>(<span class="st">&quot;SL.ranger&quot;</span>, <span class="dt">detailed_names =</span> <span class="ot">TRUE</span>, </span>
<span id="cb266-67"><a href="modeling.html#cb266-67"></a>                        <span class="dt">params =</span> <span class="kw">list</span>(<span class="dt">num.threads =</span> <span class="kw">get_cores</span>(),</span>
<span id="cb266-68"><a href="modeling.html#cb266-68"></a>                                      <span class="co"># Set this based on the convergence analysis.</span></span>
<span id="cb266-69"><a href="modeling.html#cb266-69"></a>                                      <span class="dt">num.trees =</span> <span class="dv">200</span>),</span>
<span id="cb266-70"><a href="modeling.html#cb266-70"></a>                        <span class="dt">tune =</span> <span class="kw">list</span>(</span>
<span id="cb266-71"><a href="modeling.html#cb266-71"></a>                          <span class="co"># 9 combos.</span></span>
<span id="cb266-72"><a href="modeling.html#cb266-72"></a>                          <span class="dt">min.node.size =</span> <span class="kw">c</span>(2L, 5L, 15L),</span>
<span id="cb266-73"><a href="modeling.html#cb266-73"></a>                          <span class="dt">mtry =</span> <span class="kw">floor</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>) <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">ncol</span>(X)))))</span>
<span id="cb266-74"><a href="modeling.html#cb266-74"></a>  </span>
<span id="cb266-75"><a href="modeling.html#cb266-75"></a>  <span class="co"># Run SuperLearner.</span></span>
<span id="cb266-76"><a href="modeling.html#cb266-76"></a>  <span class="co"># id argument is not being passed to avoid an error &quot;stratified sampling with id not currently implemented&quot;</span></span>
<span id="cb266-77"><a href="modeling.html#cb266-77"></a>  sl =<span class="st"> </span><span class="kw">SuperLearner</span>(<span class="dt">Y =</span> Y, <span class="dt">X =</span> X, <span class="dt">newX =</span> newX, <span class="dt">obsWeights =</span> obsWeights, <span class="dt">family =</span> family,</span>
<span id="cb266-78"><a href="modeling.html#cb266-78"></a>                    <span class="co">#SL.library = c(&quot;SL.mean&quot;, grid$names),</span></span>
<span id="cb266-79"><a href="modeling.html#cb266-79"></a>                    <span class="dt">SL.library =</span> grid<span class="op">$</span>names,</span>
<span id="cb266-80"><a href="modeling.html#cb266-80"></a>                    <span class="dt">cvControl =</span> <span class="kw">SuperLearner.CV.control</span>(<span class="dt">stratifyCV =</span> <span class="ot">TRUE</span>,</span>
<span id="cb266-81"><a href="modeling.html#cb266-81"></a>                                                        <span class="co"># Set to 2 for tutorial.</span></span>
<span id="cb266-82"><a href="modeling.html#cb266-82"></a>                                                        <span class="dt">V =</span> 2L),</span>
<span id="cb266-83"><a href="modeling.html#cb266-83"></a>                                                        <span class="co">#V = 5L),</span></span>
<span id="cb266-84"><a href="modeling.html#cb266-84"></a>                    <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb266-85"><a href="modeling.html#cb266-85"></a>  </span>
<span id="cb266-86"><a href="modeling.html#cb266-86"></a>  <span class="kw">cat</span>(<span class="st">&quot;RF tuned SL:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb266-87"><a href="modeling.html#cb266-87"></a>  <span class="kw">print</span>(sl)</span>
<span id="cb266-88"><a href="modeling.html#cb266-88"></a>  </span>
<span id="cb266-89"><a href="modeling.html#cb266-89"></a>  <span class="co"># fit returns all objects needed for predict()</span></span>
<span id="cb266-90"><a href="modeling.html#cb266-90"></a>  fit =<span class="st"> </span><span class="kw">list</span>(<span class="dt">object =</span> sl)</span>
<span id="cb266-91"><a href="modeling.html#cb266-91"></a>  </span>
<span id="cb266-92"><a href="modeling.html#cb266-92"></a>  <span class="co"># Declare class of fit for predict()</span></span>
<span id="cb266-93"><a href="modeling.html#cb266-93"></a>  <span class="kw">class</span>(fit) =<span class="st"> &#39;SuperLearner&#39;</span></span>
<span id="cb266-94"><a href="modeling.html#cb266-94"></a>  </span>
<span id="cb266-95"><a href="modeling.html#cb266-95"></a>  out =<span class="st"> </span><span class="kw">list</span>(<span class="dt">pred =</span> sl<span class="op">$</span>SL.predict, <span class="dt">fit =</span> fit)</span>
<span id="cb266-96"><a href="modeling.html#cb266-96"></a>  <span class="kw">return</span>(out)</span>
<span id="cb266-97"><a href="modeling.html#cb266-97"></a>}</span>
<span id="cb266-98"><a href="modeling.html#cb266-98"></a></span>
<span id="cb266-99"><a href="modeling.html#cb266-99"></a>glmnet_tune =<span class="st"> </span><span class="cf">function</span>(Y, X, newX, family, obsWeights, id, ...) {</span>
<span id="cb266-100"><a href="modeling.html#cb266-100"></a>  <span class="kw">cat</span>(<span class="st">&quot;Running glmnet_tune</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb266-101"><a href="modeling.html#cb266-101"></a>  </span>
<span id="cb266-102"><a href="modeling.html#cb266-102"></a>  <span class="co"># Create tuning grid.</span></span>
<span id="cb266-103"><a href="modeling.html#cb266-103"></a>  grid =<span class="st"> </span><span class="kw">create.Learner</span>(<span class="st">&quot;SL.glmnet_fast&quot;</span>, <span class="dt">detailed_names =</span> <span class="ot">TRUE</span>, </span>
<span id="cb266-104"><a href="modeling.html#cb266-104"></a>                        <span class="co"># 4 combos</span></span>
<span id="cb266-105"><a href="modeling.html#cb266-105"></a>                        <span class="dt">tune =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="fl">0.95</span>)))</span>
<span id="cb266-106"><a href="modeling.html#cb266-106"></a>  </span>
<span id="cb266-107"><a href="modeling.html#cb266-107"></a>  <span class="co"># Run SuperLearner.</span></span>
<span id="cb266-108"><a href="modeling.html#cb266-108"></a>  <span class="co"># id argument is not being passed to avoid an error &quot;stratified sampling with id not currently implemented&quot;</span></span>
<span id="cb266-109"><a href="modeling.html#cb266-109"></a>  sl =<span class="st"> </span><span class="kw">SuperLearner</span>(<span class="dt">Y =</span> Y, <span class="dt">X =</span> X, <span class="dt">newX =</span> newX, <span class="dt">obsWeights =</span> obsWeights, <span class="dt">family =</span> family,</span>
<span id="cb266-110"><a href="modeling.html#cb266-110"></a>                    <span class="dt">SL.library =</span> grid<span class="op">$</span>names,</span>
<span id="cb266-111"><a href="modeling.html#cb266-111"></a>                    <span class="dt">cvControl =</span> <span class="kw">SuperLearner.CV.control</span>(<span class="dt">stratifyCV =</span> <span class="ot">TRUE</span>,</span>
<span id="cb266-112"><a href="modeling.html#cb266-112"></a>                                                        <span class="co"># Set to 2 for tutorial purposes.</span></span>
<span id="cb266-113"><a href="modeling.html#cb266-113"></a>                                                        <span class="dt">V =</span> 2L), </span>
<span id="cb266-114"><a href="modeling.html#cb266-114"></a>                                                        <span class="co">#V = 5L),</span></span>
<span id="cb266-115"><a href="modeling.html#cb266-115"></a>                    <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb266-116"><a href="modeling.html#cb266-116"></a>  </span>
<span id="cb266-117"><a href="modeling.html#cb266-117"></a>  <span class="kw">cat</span>(<span class="st">&quot;Glmnet tuned SL:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb266-118"><a href="modeling.html#cb266-118"></a>  <span class="kw">print</span>(sl)</span>
<span id="cb266-119"><a href="modeling.html#cb266-119"></a>  </span>
<span id="cb266-120"><a href="modeling.html#cb266-120"></a>  <span class="co"># </span><span class="al">TODO</span><span class="co">: may need to save the learners, put them in the global environment, or otherwise</span></span>
<span id="cb266-121"><a href="modeling.html#cb266-121"></a>  <span class="co"># handle in a custom predict() method.</span></span>
<span id="cb266-122"><a href="modeling.html#cb266-122"></a>  </span>
<span id="cb266-123"><a href="modeling.html#cb266-123"></a>  <span class="co"># fit returns all objects needed for predict()</span></span>
<span id="cb266-124"><a href="modeling.html#cb266-124"></a>  fit =<span class="st"> </span><span class="kw">list</span>(<span class="dt">object =</span> sl)</span>
<span id="cb266-125"><a href="modeling.html#cb266-125"></a>  </span>
<span id="cb266-126"><a href="modeling.html#cb266-126"></a>  <span class="co"># Declare class of fit for predict()</span></span>
<span id="cb266-127"><a href="modeling.html#cb266-127"></a>  <span class="kw">class</span>(fit) =<span class="st"> &#39;SuperLearner&#39;</span></span>
<span id="cb266-128"><a href="modeling.html#cb266-128"></a>  </span>
<span id="cb266-129"><a href="modeling.html#cb266-129"></a>  out =<span class="st"> </span><span class="kw">list</span>(<span class="dt">pred =</span> sl<span class="op">$</span>SL.predict, <span class="dt">fit =</span> fit)</span>
<span id="cb266-130"><a href="modeling.html#cb266-130"></a>  <span class="kw">return</span>(out)</span>
<span id="cb266-131"><a href="modeling.html#cb266-131"></a>}</span>
<span id="cb266-132"><a href="modeling.html#cb266-132"></a></span>
<span id="cb266-133"><a href="modeling.html#cb266-133"></a>rpart_tune =<span class="st"> </span><span class="cf">function</span>(Y, X, newX, family, obsWeights, id, ...) {</span>
<span id="cb266-134"><a href="modeling.html#cb266-134"></a>  <span class="kw">cat</span>(<span class="st">&quot;Running rpart_tune</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb266-135"><a href="modeling.html#cb266-135"></a>  </span>
<span id="cb266-136"><a href="modeling.html#cb266-136"></a>  <span class="co"># Create tuning grid.</span></span>
<span id="cb266-137"><a href="modeling.html#cb266-137"></a>  grid =<span class="st"> </span><span class="kw">create.Learner</span>(<span class="st">&quot;SL.rpart2&quot;</span>, <span class="dt">detailed_names =</span> <span class="ot">TRUE</span>, </span>
<span id="cb266-138"><a href="modeling.html#cb266-138"></a>                        <span class="dt">tune =</span> <span class="kw">list</span>(<span class="dt">cp =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>),</span>
<span id="cb266-139"><a href="modeling.html#cb266-139"></a>                                    <span class="dt">minsplit =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">80</span>),</span>
<span id="cb266-140"><a href="modeling.html#cb266-140"></a>                                    <span class="dt">maxdepth =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">15</span>)))</span>
<span id="cb266-141"><a href="modeling.html#cb266-141"></a>  </span>
<span id="cb266-142"><a href="modeling.html#cb266-142"></a>  <span class="co"># Run SuperLearner.</span></span>
<span id="cb266-143"><a href="modeling.html#cb266-143"></a>  <span class="co"># id argument is not being passed to avoid an error &quot;stratified sampling with id not currently implemented&quot;</span></span>
<span id="cb266-144"><a href="modeling.html#cb266-144"></a>  sl =<span class="st"> </span><span class="kw">SuperLearner</span>(<span class="dt">Y =</span> Y, <span class="dt">X =</span> X, <span class="dt">newX =</span> newX, <span class="dt">obsWeights =</span> obsWeights, <span class="dt">family =</span> family,</span>
<span id="cb266-145"><a href="modeling.html#cb266-145"></a>                    <span class="co">#SL.library = c(&quot;SL.mean&quot;, grid$names),</span></span>
<span id="cb266-146"><a href="modeling.html#cb266-146"></a>                    <span class="dt">SL.library =</span> grid<span class="op">$</span>names,</span>
<span id="cb266-147"><a href="modeling.html#cb266-147"></a>                    <span class="dt">cvControl =</span> <span class="kw">SuperLearner.CV.control</span>(<span class="dt">stratifyCV =</span> <span class="ot">TRUE</span>, <span class="dt">V =</span> 5L),</span>
<span id="cb266-148"><a href="modeling.html#cb266-148"></a>                    <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb266-149"><a href="modeling.html#cb266-149"></a>  </span>
<span id="cb266-150"><a href="modeling.html#cb266-150"></a>  <span class="kw">cat</span>(<span class="st">&quot;Rpart tuned SL:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb266-151"><a href="modeling.html#cb266-151"></a>  <span class="kw">print</span>(sl)</span>
<span id="cb266-152"><a href="modeling.html#cb266-152"></a>  </span>
<span id="cb266-153"><a href="modeling.html#cb266-153"></a>  <span class="co"># </span><span class="al">TODO</span><span class="co">: may need to save the learners, put them in the global environment, or otherwise</span></span>
<span id="cb266-154"><a href="modeling.html#cb266-154"></a>  <span class="co"># handle in a custom predict() method.</span></span>
<span id="cb266-155"><a href="modeling.html#cb266-155"></a>  </span>
<span id="cb266-156"><a href="modeling.html#cb266-156"></a>  <span class="co"># fit returns all objects needed for predict()</span></span>
<span id="cb266-157"><a href="modeling.html#cb266-157"></a>  fit =<span class="st"> </span><span class="kw">list</span>(<span class="dt">object =</span> sl)</span>
<span id="cb266-158"><a href="modeling.html#cb266-158"></a>  </span>
<span id="cb266-159"><a href="modeling.html#cb266-159"></a>  <span class="co"># Declare class of fit for predict()</span></span>
<span id="cb266-160"><a href="modeling.html#cb266-160"></a>  <span class="kw">class</span>(fit) =<span class="st"> &#39;SuperLearner&#39;</span></span>
<span id="cb266-161"><a href="modeling.html#cb266-161"></a>  </span>
<span id="cb266-162"><a href="modeling.html#cb266-162"></a>  out =<span class="st"> </span><span class="kw">list</span>(<span class="dt">pred =</span> sl<span class="op">$</span>SL.predict, <span class="dt">fit =</span> fit)</span>
<span id="cb266-163"><a href="modeling.html#cb266-163"></a>  <span class="kw">return</span>(out)</span>
<span id="cb266-164"><a href="modeling.html#cb266-164"></a>}</span>
<span id="cb266-165"><a href="modeling.html#cb266-165"></a></span>
<span id="cb266-166"><a href="modeling.html#cb266-166"></a>learner_mgcv =</span>
<span id="cb266-167"><a href="modeling.html#cb266-167"></a><span class="st">  </span><span class="kw">create.Learner</span>(<span class="st">&quot;SL.mgcv2&quot;</span>,</span>
<span id="cb266-168"><a href="modeling.html#cb266-168"></a>                 <span class="dt">detailed_names =</span> <span class="ot">TRUE</span>,</span>
<span id="cb266-169"><a href="modeling.html#cb266-169"></a>                 <span class="dt">params =</span> <span class="kw">list</span>(<span class="dt">nthreads =</span> <span class="kw">min</span>(10L, <span class="kw">get_cores</span>()),</span>
<span id="cb266-170"><a href="modeling.html#cb266-170"></a>                               <span class="dt">continuous_values =</span> 10L))</span>
<span id="cb266-171"><a href="modeling.html#cb266-171"></a></span>
<span id="cb266-172"><a href="modeling.html#cb266-172"></a></span>
<span id="cb266-173"><a href="modeling.html#cb266-173"></a>(<span class="dt">sl_lib =</span> <span class="kw">c</span>(<span class="kw">list</span>(<span class="st">&quot;SL.mean&quot;</span>,</span>
<span id="cb266-174"><a href="modeling.html#cb266-174"></a>                 <span class="st">&quot;SL.lm2&quot;</span>,</span>
<span id="cb266-175"><a href="modeling.html#cb266-175"></a>                 <span class="st">&quot;SL.glm2&quot;</span>,</span>
<span id="cb266-176"><a href="modeling.html#cb266-176"></a>                 <span class="st">&quot;SL.glmnet_fast&quot;</span>),</span>
<span id="cb266-177"><a href="modeling.html#cb266-177"></a><span class="co">#           stratified_lib$names, </span></span>
<span id="cb266-178"><a href="modeling.html#cb266-178"></a><span class="co">#           rpart_pruned$names,</span></span>
<span id="cb266-179"><a href="modeling.html#cb266-179"></a>           learner_mgcv<span class="op">$</span>names,</span>
<span id="cb266-180"><a href="modeling.html#cb266-180"></a>          <span class="kw">list</span>(</span>
<span id="cb266-181"><a href="modeling.html#cb266-181"></a>            <span class="st">&quot;rpart_tune&quot;</span>,</span>
<span id="cb266-182"><a href="modeling.html#cb266-182"></a>            <span class="st">&quot;SL.ranger_200&quot;</span>,</span>
<span id="cb266-183"><a href="modeling.html#cb266-183"></a>            <span class="st">&quot;rf_tune&quot;</span>,</span>
<span id="cb266-184"><a href="modeling.html#cb266-184"></a>            <span class="st">&quot;SL.dbarts_200&quot;</span>,</span>
<span id="cb266-185"><a href="modeling.html#cb266-185"></a>            <span class="st">&quot;xgb_tune&quot;</span>,</span>
<span id="cb266-186"><a href="modeling.html#cb266-186"></a>            <span class="st">&quot;SL.xgboost_fast&quot;</span>)))</span></code></pre></div>
<pre><code>## [[1]]
## [1] &quot;SL.mean&quot;
## 
## [[2]]
## [1] &quot;SL.lm2&quot;
## 
## [[3]]
## [1] &quot;SL.glm2&quot;
## 
## [[4]]
## [1] &quot;SL.glmnet_fast&quot;
## 
## [[5]]
## [1] &quot;SL.mgcv2_1&quot;
## 
## [[6]]
## [1] &quot;rpart_tune&quot;
## 
## [[7]]
## [1] &quot;SL.ranger_200&quot;
## 
## [[8]]
## [1] &quot;rf_tune&quot;
## 
## [[9]]
## [1] &quot;SL.dbarts_200&quot;
## 
## [[10]]
## [1] &quot;xgb_tune&quot;
## 
## [[11]]
## [1] &quot;SL.xgboost_fast&quot;</code></pre>
</div>
<div id="estimate-superlearner" class="section level3">
<h3><span class="header-section-number">6.2.2</span> Estimate SuperLearner</h3>
<p>The results of this block are cached because they are slow to compute.</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="modeling.html#cb268-1"></a><span class="kw">set.seed</span>(<span class="dv">1</span>, <span class="st">&quot;L&#39;Ecuyer-CMRG&quot;</span>)</span>
<span id="cb268-2"><a href="modeling.html#cb268-2"></a></span>
<span id="cb268-3"><a href="modeling.html#cb268-3"></a>(<span class="dt">sl =</span> <span class="kw">SuperLearner</span>(<span class="dt">Y =</span> data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]],</span>
<span id="cb268-4"><a href="modeling.html#cb268-4"></a>                   <span class="dt">X =</span> data[, vars<span class="op">$</span>predictors],</span>
<span id="cb268-5"><a href="modeling.html#cb268-5"></a>                   <span class="dt">family =</span> <span class="kw">binomial</span>(), <span class="dt">SL.library =</span> sl_lib,</span>
<span id="cb268-6"><a href="modeling.html#cb268-6"></a>                   <span class="dt">cvControl =</span> <span class="kw">SuperLearner.CV.control</span>(<span class="dt">stratifyCV =</span> <span class="ot">TRUE</span>,</span>
<span id="cb268-7"><a href="modeling.html#cb268-7"></a>                                                      <span class="co">#V = 10L),</span></span>
<span id="cb268-8"><a href="modeling.html#cb268-8"></a>                                                      <span class="dt">V =</span> 2L),</span>
<span id="cb268-9"><a href="modeling.html#cb268-9"></a>                  <span class="dt">verbose =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## Number of covariates in All is: 33</code></pre>
<pre><code>## CV SL.mean_All</code></pre>
<pre><code>## Warning in predict.lm(fit, newdata = newX, type = &quot;response&quot;): prediction from a
## rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.lm2_All</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.glm2_All</code></pre>
<pre><code>## Warning: executing %dopar% sequentially: no parallel backend registered</code></pre>
<pre><code>## CV SL.glmnet_fast_All</code></pre>
<pre><code>## CV SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk      Coef
## SL.rpart2_0_10_5_All     0.2027929 0.0000000
## SL.rpart2_0.01_10_5_All  0.2027929 0.0000000
## SL.rpart2_0_20_5_All     0.1807607 0.0000000
## SL.rpart2_0.01_20_5_All  0.1771161 0.0000000
## SL.rpart2_0_80_5_All     0.1648992 0.7542944
## SL.rpart2_0.01_80_5_All  0.1648992 0.0000000
## SL.rpart2_0_10_15_All    0.2102988 0.0000000
## SL.rpart2_0.01_10_15_All 0.1988584 0.2457056
## SL.rpart2_0_20_15_All    0.1807607 0.0000000
## SL.rpart2_0.01_20_15_All 0.1771161 0.0000000
## SL.rpart2_0_80_15_All    0.1648992 0.0000000
## SL.rpart2_0.01_80_15_All 0.1648992 0.0000000</code></pre>
<pre><code>## CV rpart_tune_All</code></pre>
<pre><code>## CV SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk       Coef
## SL.ranger_2_2_All   0.1491320 0.00000000
## SL.ranger_5_2_All   0.1502432 0.00000000
## SL.ranger_15_2_All  0.1526904 0.00000000
## SL.ranger_2_5_All   0.1362120 0.92060845
## SL.ranger_5_5_All   0.1377101 0.07939155
## SL.ranger_15_5_All  0.1426574 0.00000000
## SL.ranger_2_11_All  0.1417842 0.00000000
## SL.ranger_5_11_All  0.1432871 0.00000000
## SL.ranger_15_11_All 0.1438529 0.00000000</code></pre>
<pre><code>## CV rf_tune_All</code></pre>
<pre><code>## CV SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk Coef
## SL.xgboost_fast_250_2_0.05_All  0.2481858    1
## SL.xgboost_fast_1000_2_0.05_All 0.2481858    0
## SL.xgboost_fast_250_4_0.05_All  0.2481858    0
## SL.xgboost_fast_1000_4_0.05_All 0.2481858    0
## SL.xgboost_fast_250_2_0.2_All   0.2481858    0
## SL.xgboost_fast_1000_2_0.2_All  0.2481858    0
## SL.xgboost_fast_250_4_0.2_All   0.2481858    0
## SL.xgboost_fast_1000_4_0.2_All  0.2481858    0</code></pre>
<pre><code>## CV xgb_tune_All</code></pre>
<pre><code>## CV SL.xgboost_fast_All</code></pre>
<pre><code>## Number of covariates in All is: 33</code></pre>
<pre><code>## CV SL.mean_All</code></pre>
<pre><code>## Warning in predict.lm(fit, newdata = newX, type = &quot;response&quot;): prediction from a
## rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.lm2_All</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.glm2_All</code></pre>
<pre><code>## CV SL.glmnet_fast_All</code></pre>
<pre><code>## CV SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk      Coef
## SL.rpart2_0_10_5_All     0.2500382 0.0000000
## SL.rpart2_0.01_10_5_All  0.2500382 0.0000000
## SL.rpart2_0_20_5_All     0.1975844 0.7256534
## SL.rpart2_0.01_20_5_All  0.2023409 0.0000000
## SL.rpart2_0_80_5_All     0.2154568 0.2743466
## SL.rpart2_0.01_80_5_All  0.2154568 0.0000000
## SL.rpart2_0_10_15_All    0.2599618 0.0000000
## SL.rpart2_0.01_10_15_All 0.2599618 0.0000000
## SL.rpart2_0_20_15_All    0.2001702 0.0000000
## SL.rpart2_0.01_20_15_All 0.2049266 0.0000000
## SL.rpart2_0_80_15_All    0.2154568 0.0000000
## SL.rpart2_0.01_80_15_All 0.2154568 0.0000000</code></pre>
<pre><code>## CV rpart_tune_All</code></pre>
<pre><code>## CV SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk      Coef
## SL.ranger_2_2_All   0.1674269 0.0000000
## SL.ranger_5_2_All   0.1694906 0.0000000
## SL.ranger_15_2_All  0.1688027 0.1498788
## SL.ranger_2_5_All   0.1593110 0.8501212
## SL.ranger_5_5_All   0.1626210 0.0000000
## SL.ranger_15_5_All  0.1642748 0.0000000
## SL.ranger_2_11_All  0.1739733 0.0000000
## SL.ranger_5_11_All  0.1753413 0.0000000
## SL.ranger_15_11_All 0.1833558 0.0000000</code></pre>
<pre><code>## CV rf_tune_All</code></pre>
<pre><code>## CV SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk Coef
## SL.xgboost_fast_250_2_0.05_All  0.2478803    1
## SL.xgboost_fast_1000_2_0.05_All 0.2478803    0
## SL.xgboost_fast_250_4_0.05_All  0.2478803    0
## SL.xgboost_fast_1000_4_0.05_All 0.2478803    0
## SL.xgboost_fast_250_2_0.2_All   0.2478803    0
## SL.xgboost_fast_1000_2_0.2_All  0.2478803    0
## SL.xgboost_fast_250_4_0.2_All   0.2478803    0
## SL.xgboost_fast_1000_4_0.2_All  0.2478803    0</code></pre>
<pre><code>## CV xgb_tune_All</code></pre>
<pre><code>## CV SL.xgboost_fast_All</code></pre>
<pre><code>## Non-Negative least squares convergence: TRUE</code></pre>
<pre><code>## full SL.mean_All</code></pre>
<pre><code>## full SL.lm2_All</code></pre>
<pre><code>## full SL.glm2_All</code></pre>
<pre><code>## full SL.glmnet_fast_All</code></pre>
<pre><code>## full SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk      Coef
## SL.rpart2_0_10_5_All     0.2137125 0.0000000
## SL.rpart2_0.01_10_5_All  0.2138648 0.0000000
## SL.rpart2_0_20_5_All     0.1967678 0.0000000
## SL.rpart2_0.01_20_5_All  0.2045359 0.0000000
## SL.rpart2_0_80_5_All     0.1846070 0.5971948
## SL.rpart2_0.01_80_5_All  0.1846070 0.0000000
## SL.rpart2_0_10_15_All    0.2196851 0.2349721
## SL.rpart2_0.01_10_15_All 0.2132001 0.0000000
## SL.rpart2_0_20_15_All    0.1952689 0.1678331
## SL.rpart2_0.01_20_15_All 0.2030371 0.0000000
## SL.rpart2_0_80_15_All    0.1846070 0.0000000
## SL.rpart2_0.01_80_15_All 0.1846070 0.0000000</code></pre>
<pre><code>## full rpart_tune_All</code></pre>
<pre><code>## full SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk Coef
## SL.ranger_2_2_All   0.1459784    0
## SL.ranger_5_2_All   0.1464061    0
## SL.ranger_15_2_All  0.1484737    0
## SL.ranger_2_5_All   0.1400146    0
## SL.ranger_5_5_All   0.1378980    1
## SL.ranger_15_5_All  0.1402499    0
## SL.ranger_2_11_All  0.1433777    0
## SL.ranger_5_11_All  0.1423325    0
## SL.ranger_15_11_All 0.1447646    0</code></pre>
<pre><code>## full rf_tune_All</code></pre>
<pre><code>## full SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk      Coef
## SL.xgboost_fast_250_2_0.05_All  0.1622281 0.2970516
## SL.xgboost_fast_1000_2_0.05_All 0.1622301 0.7029484
## SL.xgboost_fast_250_4_0.05_All  0.1622281 0.0000000
## SL.xgboost_fast_1000_4_0.05_All 0.1622301 0.0000000
## SL.xgboost_fast_250_2_0.2_All   0.1623268 0.0000000
## SL.xgboost_fast_1000_2_0.2_All  0.1627611 0.0000000
## SL.xgboost_fast_250_4_0.2_All   0.1623268 0.0000000
## SL.xgboost_fast_1000_4_0.2_All  0.1627611 0.0000000</code></pre>
<pre><code>## full xgb_tune_All</code></pre>
<pre><code>## full SL.xgboost_fast_All</code></pre>
<pre><code>## 
## Call:  
## SuperLearner(Y = data[[vars$outcomes[1]]], X = data[, vars$predictors], family = binomial(),  
##     SL.library = sl_lib, verbose = TRUE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L)) 
## 
## 
##                          Risk      Coef
## SL.mean_All         0.2480217 0.0000000
## SL.lm2_All          0.1138972 0.3694042
## SL.glm2_All         0.1592580 0.0000000
## SL.glmnet_fast_All  0.1126716 0.3544172
## SL.mgcv2_1_All      0.1646661 0.0000000
## rpart_tune_All      0.1768881 0.0000000
## SL.ranger_200_All   0.1338529 0.0000000
## rf_tune_All         0.1306389 0.0000000
## SL.dbarts_200_All   0.1171052 0.2761786
## xgb_tune_All        0.1489688 0.0000000
## SL.xgboost_fast_All 0.1517064 0.0000000</code></pre>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="modeling.html#cb320-1"></a>sl</span></code></pre></div>
<pre><code>## 
## Call:  
## SuperLearner(Y = data[[vars$outcomes[1]]], X = data[, vars$predictors], family = binomial(),  
##     SL.library = sl_lib, verbose = TRUE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L)) 
## 
## 
##                          Risk      Coef
## SL.mean_All         0.2480217 0.0000000
## SL.lm2_All          0.1138972 0.3694042
## SL.glm2_All         0.1592580 0.0000000
## SL.glmnet_fast_All  0.1126716 0.3544172
## SL.mgcv2_1_All      0.1646661 0.0000000
## rpart_tune_All      0.1768881 0.0000000
## SL.ranger_200_All   0.1338529 0.0000000
## rf_tune_All         0.1306389 0.0000000
## SL.dbarts_200_All   0.1171052 0.2761786
## xgb_tune_All        0.1489688 0.0000000
## SL.xgboost_fast_All 0.1517064 0.0000000</code></pre>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="modeling.html#cb322-1"></a><span class="kw">save</span>(sl,</span>
<span id="cb322-2"><a href="modeling.html#cb322-2"></a>     <span class="dt">file =</span> <span class="st">&quot;data/estimator-sl.RData&quot;</span>)</span></code></pre></div>
</div>
<div id="review-sl-results" class="section level3">
<h3><span class="header-section-number">6.2.3</span> Review SL results</h3>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="modeling.html#cb323-1"></a>(<span class="dt">auc_tab =</span> ck37r<span class="op">::</span><span class="kw">auc_table</span>(sl, <span class="dt">y =</span> data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]]))</span></code></pre></div>
<pre><code>##                learner       auc         se  ci_lower  ci_upper      p-value
## 1          SL.mean_All 0.5000000 0.05767800 0.3869532 0.6130468 1.582959e-13
## 6       rpart_tune_All 0.7987970 0.03299236 0.7341331 0.8634608 1.152513e-04
## 5       SL.mgcv2_1_All 0.8368735 0.02542988 0.7870318 0.8867151 5.172679e-04
## 11 SL.xgboost_fast_All 0.8565402 0.02169579 0.8140172 0.8990631 1.645421e-03
## 3          SL.glm2_All 0.8599265 0.02240240 0.8160185 0.9038344 3.516119e-03
## 10        xgb_tune_All 0.8622278 0.02144475 0.8201969 0.9042588 3.380814e-03
## 7    SL.ranger_200_All 0.8948072 0.01792615 0.8596726 0.9299418 7.743425e-02
## 8          rf_tune_All 0.9020642 0.01727790 0.8682002 0.9359283 1.455073e-01
## 4   SL.glmnet_fast_All 0.9149179 0.01705660 0.8814876 0.9483482 3.759973e-01
## 9    SL.dbarts_200_All 0.9168423 0.01622459 0.8850427 0.9486420 4.154285e-01
## 2           SL.lm2_All 0.9203080 0.01685427 0.8872742 0.9533417 5.000000e-01</code></pre>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="modeling.html#cb325-1"></a><span class="co"># Drop p-value column.</span></span>
<span id="cb325-2"><a href="modeling.html#cb325-2"></a>auc_tab2 =<span class="st"> </span>auc_tab[, <span class="op">!</span><span class="kw">names</span>(auc_tab) <span class="op">%in%</span><span class="st"> &quot;p-value&quot;</span>]</span>
<span id="cb325-3"><a href="modeling.html#cb325-3"></a></span>
<span id="cb325-4"><a href="modeling.html#cb325-4"></a></span>
<span id="cb325-5"><a href="modeling.html#cb325-5"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: convert to knitr/kableExtra</span></span>
<span id="cb325-6"><a href="modeling.html#cb325-6"></a><span class="kw">print</span>(xtable<span class="op">::</span><span class="kw">xtable</span>(auc_tab2, <span class="dt">digits =</span> <span class="dv">4</span>), <span class="dt">type =</span> <span class="st">&quot;latex&quot;</span>,</span>
<span id="cb325-7"><a href="modeling.html#cb325-7"></a>      <span class="dt">file =</span> <span class="st">&quot;tables/sl-auc_table.tex&quot;</span>)</span>
<span id="cb325-8"><a href="modeling.html#cb325-8"></a></span>
<span id="cb325-9"><a href="modeling.html#cb325-9"></a>ck37r<span class="op">::</span><span class="kw">plot_roc</span>(sl, <span class="dt">y =</span> data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]])</span></code></pre></div>
<p><img src="data-science-in-r_files/figure-html/review_sl-1.png" width="672" /></p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="modeling.html#cb326-1"></a><span class="kw">ggsave</span>(<span class="st">&quot;visuals/roc-superlearner.pdf&quot;</span>)</span></code></pre></div>
<pre><code>## Saving 7 x 5 in image</code></pre>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="modeling.html#cb328-1"></a>plot_table =<span class="st"> </span><span class="cf">function</span>(x,</span>
<span id="cb328-2"><a href="modeling.html#cb328-2"></a>                      <span class="dt">metric =</span> <span class="st">&quot;auc&quot;</span>,</span>
<span id="cb328-3"><a href="modeling.html#cb328-3"></a>                      <span class="dt">sort =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb328-4"><a href="modeling.html#cb328-4"></a></span>
<span id="cb328-5"><a href="modeling.html#cb328-5"></a>  <span class="co"># Use a clearer object name.</span></span>
<span id="cb328-6"><a href="modeling.html#cb328-6"></a>  tab =<span class="st"> </span>x</span>
<span id="cb328-7"><a href="modeling.html#cb328-7"></a></span>
<span id="cb328-8"><a href="modeling.html#cb328-8"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(sort)) {</span>
<span id="cb328-9"><a href="modeling.html#cb328-9"></a>    tab =<span class="st"> </span>tab[<span class="kw">order</span>(tab[[metric]], <span class="dt">decreasing =</span> sort), ]</span>
<span id="cb328-10"><a href="modeling.html#cb328-10"></a>  }</span>
<span id="cb328-11"><a href="modeling.html#cb328-11"></a></span>
<span id="cb328-12"><a href="modeling.html#cb328-12"></a>  <span class="co"># Convert to a factor with manual levels so ggplot doesn&#39;t re-order</span></span>
<span id="cb328-13"><a href="modeling.html#cb328-13"></a>  <span class="co"># alphabetically.</span></span>
<span id="cb328-14"><a href="modeling.html#cb328-14"></a>  tab<span class="op">$</span>learner =<span class="st"> </span><span class="kw">factor</span>(tab<span class="op">$</span>learner, <span class="dt">levels =</span> tab<span class="op">$</span>learner)</span>
<span id="cb328-15"><a href="modeling.html#cb328-15"></a></span>
<span id="cb328-16"><a href="modeling.html#cb328-16"></a>  <span class="kw">rownames</span>(tab) =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb328-17"><a href="modeling.html#cb328-17"></a></span>
<span id="cb328-18"><a href="modeling.html#cb328-18"></a>  p =</span>
<span id="cb328-19"><a href="modeling.html#cb328-19"></a><span class="st">    </span>ggplot2<span class="op">::</span><span class="kw">ggplot</span>(tab,</span>
<span id="cb328-20"><a href="modeling.html#cb328-20"></a>           <span class="kw">aes</span>(<span class="dt">x =</span> learner, <span class="dt">y =</span> <span class="kw">get</span>(metric), <span class="dt">ymin =</span> ci_lower, <span class="dt">ymax =</span> ci_upper)) <span class="op">+</span></span>
<span id="cb328-21"><a href="modeling.html#cb328-21"></a><span class="st">      </span>ggplot2<span class="op">::</span><span class="kw">geom_pointrange</span>(<span class="dt">fatten =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb328-22"><a href="modeling.html#cb328-22"></a><span class="st">      </span>ggplot2<span class="op">::</span><span class="kw">coord_flip</span>() <span class="op">+</span></span>
<span id="cb328-23"><a href="modeling.html#cb328-23"></a><span class="st">      </span>ggplot2<span class="op">::</span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Learner&quot;</span>, <span class="dt">y =</span> metric) <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>()</span>
<span id="cb328-24"><a href="modeling.html#cb328-24"></a></span>
<span id="cb328-25"><a href="modeling.html#cb328-25"></a>  <span class="kw">return</span>(p)</span>
<span id="cb328-26"><a href="modeling.html#cb328-26"></a>}</span>
<span id="cb328-27"><a href="modeling.html#cb328-27"></a></span>
<span id="cb328-28"><a href="modeling.html#cb328-28"></a><span class="co"># Skip SL.mean - it&#39;s too low to be worth plotting.</span></span>
<span id="cb328-29"><a href="modeling.html#cb328-29"></a><span class="kw">plot_table</span>(auc_tab[<span class="op">-</span><span class="dv">1</span>, ]) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Cross-validated ROC-AUC&quot;</span>)</span></code></pre></div>
<p><img src="data-science-in-r_files/figure-html/review_sl-2.png" width="672" /></p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="modeling.html#cb329-1"></a><span class="kw">ggsave</span>(<span class="st">&quot;visuals/sl-roc-auc-comparison.pdf&quot;</span>)</span></code></pre></div>
<pre><code>## Saving 7 x 5 in image</code></pre>
</div>
<div id="sl-pr-auc" class="section level3">
<h3><span class="header-section-number">6.2.4</span> SL PR-AUC</h3>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="modeling.html#cb331-1"></a>(<span class="dt">prauc_tab =</span> ck37r<span class="op">::</span><span class="kw">prauc_table</span>(sl, <span class="dt">y =</span> data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]]))</span>
<span id="cb331-2"><a href="modeling.html#cb331-2"></a></span>
<span id="cb331-3"><a href="modeling.html#cb331-3"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: switch to knitr</span></span>
<span id="cb331-4"><a href="modeling.html#cb331-4"></a><span class="kw">print</span>(xtable<span class="op">::</span><span class="kw">xtable</span>(prauc_tab, <span class="dt">digits =</span> <span class="dv">4</span>), <span class="dt">type =</span> <span class="st">&quot;latex&quot;</span>,</span>
<span id="cb331-5"><a href="modeling.html#cb331-5"></a>      <span class="dt">file =</span> <span class="st">&quot;tables/sl-prauc_table.tex&quot;</span>)</span>
<span id="cb331-6"><a href="modeling.html#cb331-6"></a></span>
<span id="cb331-7"><a href="modeling.html#cb331-7"></a><span class="kw">plot_table</span>(prauc_tab, <span class="dt">metric =</span> <span class="st">&quot;prauc&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Cross-validated PR-AUC&quot;</span>)</span>
<span id="cb331-8"><a href="modeling.html#cb331-8"></a><span class="kw">ggsave</span>(<span class="st">&quot;visuals/sl-prauc-comparison.pdf&quot;</span>)</span></code></pre></div>
</div>
<div id="sl-plots" class="section level3">
<h3><span class="header-section-number">6.2.5</span> SL plots</h3>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="modeling.html#cb332-1"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb332-2"><a href="modeling.html#cb332-2"></a></span>
<span id="cb332-3"><a href="modeling.html#cb332-3"></a>df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]],</span>
<span id="cb332-4"><a href="modeling.html#cb332-4"></a>                <span class="dt">pred =</span> <span class="kw">as.vector</span>(sl<span class="op">$</span>SL.predict))</span>
<span id="cb332-5"><a href="modeling.html#cb332-5"></a></span>
<span id="cb332-6"><a href="modeling.html#cb332-6"></a>df =<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">decile =</span> <span class="kw">ntile</span>(pred, 10L),</span>
<span id="cb332-7"><a href="modeling.html#cb332-7"></a>                   <span class="dt">vigintile =</span> <span class="kw">ntile</span>(pred, 20L)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>()</span>
<span id="cb332-8"><a href="modeling.html#cb332-8"></a></span>
<span id="cb332-9"><a href="modeling.html#cb332-9"></a><span class="kw">table</span>(df<span class="op">$</span>decile)</span>
<span id="cb332-10"><a href="modeling.html#cb332-10"></a></span>
<span id="cb332-11"><a href="modeling.html#cb332-11"></a><span class="kw">summary</span>(df)</span>
<span id="cb332-12"><a href="modeling.html#cb332-12"></a></span>
<span id="cb332-13"><a href="modeling.html#cb332-13"></a><span class="co"># Compare risk distribution for 0&#39;s vs 1&#39;s</span></span>
<span id="cb332-14"><a href="modeling.html#cb332-14"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> df, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">color =</span> <span class="kw">factor</span>(y))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb332-15"><a href="modeling.html#cb332-15"></a><span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb332-16"><a href="modeling.html#cb332-16"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Distribution of predicted risk for 0&#39;s vs 1&#39;s&quot;</span>,</span>
<span id="cb332-17"><a href="modeling.html#cb332-17"></a>         <span class="dt">x =</span> <span class="st">&quot;Predicted risk Pr(Y = 1 | X)&quot;</span>,</span>
<span id="cb332-18"><a href="modeling.html#cb332-18"></a>         <span class="dt">y =</span> <span class="st">&quot;Density&quot;</span>)</span>
<span id="cb332-19"><a href="modeling.html#cb332-19"></a></span>
<span id="cb332-20"><a href="modeling.html#cb332-20"></a><span class="co"># Look at the risk distribution for each learner.</span></span>
<span id="cb332-21"><a href="modeling.html#cb332-21"></a><span class="cf">for</span> (learner_i <span class="cf">in</span> <span class="kw">seq</span>(<span class="kw">ncol</span>(sl<span class="op">$</span>Z))) {</span>
<span id="cb332-22"><a href="modeling.html#cb332-22"></a>  learner_name =<span class="st"> </span>sl<span class="op">$</span>libraryNames[learner_i]</span>
<span id="cb332-23"><a href="modeling.html#cb332-23"></a>  preds =<span class="st"> </span>sl<span class="op">$</span>Z[, learner_i, drop =<span class="st"> </span><span class="ot">TRUE</span>]</span>
<span id="cb332-24"><a href="modeling.html#cb332-24"></a>  </span>
<span id="cb332-25"><a href="modeling.html#cb332-25"></a>  df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]],</span>
<span id="cb332-26"><a href="modeling.html#cb332-26"></a>                  <span class="dt">pred =</span> preds)</span>
<span id="cb332-27"><a href="modeling.html#cb332-27"></a>  </span>
<span id="cb332-28"><a href="modeling.html#cb332-28"></a>  g =<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> df, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">color =</span> <span class="kw">factor</span>(y))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb332-29"><a href="modeling.html#cb332-29"></a><span class="st">    </span><span class="kw">geom_density</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb332-30"><a href="modeling.html#cb332-30"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Distribution of predicted risk for 0&#39;s vs 1&#39;s&quot;</span>,</span>
<span id="cb332-31"><a href="modeling.html#cb332-31"></a>         <span class="dt">subtitle =</span> <span class="kw">paste</span>(<span class="st">&quot;Learner:&quot;</span>, learner_name), </span>
<span id="cb332-32"><a href="modeling.html#cb332-32"></a>         <span class="dt">x =</span> <span class="st">&quot;Predicted risk Pr(Y = 1 | X)&quot;</span>,</span>
<span id="cb332-33"><a href="modeling.html#cb332-33"></a>         <span class="dt">y =</span> <span class="st">&quot;Density&quot;</span>)</span>
<span id="cb332-34"><a href="modeling.html#cb332-34"></a>  </span>
<span id="cb332-35"><a href="modeling.html#cb332-35"></a>  <span class="kw">print</span>(g)</span>
<span id="cb332-36"><a href="modeling.html#cb332-36"></a></span>
<span id="cb332-37"><a href="modeling.html#cb332-37"></a>}</span>
<span id="cb332-38"><a href="modeling.html#cb332-38"></a></span>
<span id="cb332-39"><a href="modeling.html#cb332-39"></a></span>
<span id="cb332-40"><a href="modeling.html#cb332-40"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> df, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">color =</span> <span class="kw">factor</span>(y))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb332-41"><a href="modeling.html#cb332-41"></a><span class="st">  </span><span class="kw">geom_freqpoly</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>()</span>
<span id="cb332-42"><a href="modeling.html#cb332-42"></a></span>
<span id="cb332-43"><a href="modeling.html#cb332-43"></a><span class="co"># Quick calibration plot</span></span>
<span id="cb332-44"><a href="modeling.html#cb332-44"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> df, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb332-45"><a href="modeling.html#cb332-45"></a><span class="st">  </span><span class="kw">geom_smooth</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb332-46"><a href="modeling.html#cb332-46"></a><span class="st">  </span><span class="kw">lims</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code></pre></div>
</div>
</div>
<div id="nested-ensemble" class="section level2">
<h2><span class="header-section-number">6.3</span> Nested ensemble</h2>
<p>The results of this block are cached because they are slow to compute.</p>
<p>Note: we are not currently saving the fitLibraries.</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="modeling.html#cb333-1"></a><span class="kw">set.seed</span>(<span class="dv">1</span>, <span class="st">&quot;L&#39;Ecuyer-CMRG&quot;</span>)</span>
<span id="cb333-2"><a href="modeling.html#cb333-2"></a></span>
<span id="cb333-3"><a href="modeling.html#cb333-3"></a><span class="co"># 2 is fastest, 10 is most thorough.</span></span>
<span id="cb333-4"><a href="modeling.html#cb333-4"></a><span class="co">#outer_cv_folds = 10L</span></span>
<span id="cb333-5"><a href="modeling.html#cb333-5"></a><span class="co">#outer_cv_folds = 5L</span></span>
<span id="cb333-6"><a href="modeling.html#cb333-6"></a><span class="co"># Low setting to speed up tutorial.</span></span>
<span id="cb333-7"><a href="modeling.html#cb333-7"></a>outer_cv_folds =<span class="st"> </span>2L</span>
<span id="cb333-8"><a href="modeling.html#cb333-8"></a></span>
<span id="cb333-9"><a href="modeling.html#cb333-9"></a>(<span class="dt">cvsl =</span></span>
<span id="cb333-10"><a href="modeling.html#cb333-10"></a>    <span class="kw">CV.SuperLearner</span>(<span class="dt">Y =</span> data[[vars<span class="op">$</span>outcomes[<span class="dv">1</span>]]], data[, vars<span class="op">$</span>predictors],</span>
<span id="cb333-11"><a href="modeling.html#cb333-11"></a>          <span class="dt">family =</span> <span class="kw">binomial</span>(), <span class="dt">SL.library =</span> sl_lib,</span>
<span id="cb333-12"><a href="modeling.html#cb333-12"></a>          <span class="dt">cvControl =</span></span>
<span id="cb333-13"><a href="modeling.html#cb333-13"></a>            <span class="kw">SuperLearner.CV.control</span>(<span class="dt">stratifyCV =</span> <span class="ot">TRUE</span>,</span>
<span id="cb333-14"><a href="modeling.html#cb333-14"></a>                                    <span class="dt">V =</span> outer_cv_folds),</span>
<span id="cb333-15"><a href="modeling.html#cb333-15"></a>          <span class="dt">innerCvControl =</span></span>
<span id="cb333-16"><a href="modeling.html#cb333-16"></a>            <span class="kw">rep</span>(<span class="kw">list</span>(<span class="kw">SuperLearner.CV.control</span>(<span class="dt">stratifyCV =</span> <span class="ot">TRUE</span>,</span>
<span id="cb333-17"><a href="modeling.html#cb333-17"></a>                                             <span class="co"># Low setting to speed up tutorial.</span></span>
<span id="cb333-18"><a href="modeling.html#cb333-18"></a>                                             <span class="dt">V =</span> 2L)),</span>
<span id="cb333-19"><a href="modeling.html#cb333-19"></a>                                             <span class="co">#V = 5L)),</span></span>
<span id="cb333-20"><a href="modeling.html#cb333-20"></a>                                             <span class="co">#V = 10L)),</span></span>
<span id="cb333-21"><a href="modeling.html#cb333-21"></a>                outer_cv_folds),</span>
<span id="cb333-22"><a href="modeling.html#cb333-22"></a>          <span class="dt">verbose =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## Number of covariates in All is: 33</code></pre>
<pre><code>## CV SL.mean_All</code></pre>
<pre><code>## Warning in predict.lm(fit, newdata = newX, type = &quot;response&quot;): prediction from a
## rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.lm2_All</code></pre>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.glm2_All</code></pre>
<pre><code>## CV SL.glmnet_fast_All</code></pre>
<pre><code>## Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =
## G$L, : Fitting terminated with step failure - check results carefully</code></pre>
<pre><code>## CV SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk      Coef
## SL.rpart2_0_10_5_All     0.2431768 0.0000000
## SL.rpart2_0.01_10_5_All  0.2431768 0.0000000
## SL.rpart2_0_20_5_All     0.1930073 0.8053982
## SL.rpart2_0.01_20_5_All  0.1930073 0.0000000
## SL.rpart2_0_80_5_All     0.2479737 0.1946018
## SL.rpart2_0.01_80_5_All  0.2479737 0.0000000
## SL.rpart2_0_10_15_All    0.2431768 0.0000000
## SL.rpart2_0.01_10_15_All 0.2431768 0.0000000
## SL.rpart2_0_20_15_All    0.1930073 0.0000000
## SL.rpart2_0.01_20_15_All 0.1930073 0.0000000
## SL.rpart2_0_80_15_All    0.2479737 0.0000000
## SL.rpart2_0.01_80_15_All 0.2479737 0.0000000</code></pre>
<pre><code>## CV rpart_tune_All</code></pre>
<pre><code>## CV SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk       Coef
## SL.ranger_2_2_All   0.1728728 0.00000000
## SL.ranger_5_2_All   0.1740868 0.00000000
## SL.ranger_15_2_All  0.1765832 0.00000000
## SL.ranger_2_5_All   0.1591611 0.00000000
## SL.ranger_5_5_All   0.1569518 0.32470449
## SL.ranger_15_5_All  0.1584887 0.61008799
## SL.ranger_2_11_All  0.1628896 0.00000000
## SL.ranger_5_11_All  0.1600054 0.00000000
## SL.ranger_15_11_All 0.1574472 0.06520752</code></pre>
<pre><code>## CV rf_tune_All</code></pre>
<pre><code>## CV SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk Coef
## SL.xgboost_fast_250_2_0.05_All  0.2479319    1
## SL.xgboost_fast_1000_2_0.05_All 0.2479319    0
## SL.xgboost_fast_250_4_0.05_All  0.2479319    0
## SL.xgboost_fast_1000_4_0.05_All 0.2479319    0
## SL.xgboost_fast_250_2_0.2_All   0.2479319    0
## SL.xgboost_fast_1000_2_0.2_All  0.2479319    0
## SL.xgboost_fast_250_4_0.2_All   0.2479319    0
## SL.xgboost_fast_1000_4_0.2_All  0.2479319    0</code></pre>
<pre><code>## CV xgb_tune_All</code></pre>
<pre><code>## CV SL.xgboost_fast_All</code></pre>
<pre><code>## Number of covariates in All is: 33</code></pre>
<pre><code>## CV SL.mean_All</code></pre>
<pre><code>## Warning in predict.lm(fit, newdata = newX, type = &quot;response&quot;): prediction from a
## rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.lm2_All</code></pre>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

## Warning: prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.glm2_All</code></pre>
<pre><code>## CV SL.glmnet_fast_All</code></pre>
<pre><code>## Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =
## G$L, : Fitting terminated with step failure - check results carefully</code></pre>
<pre><code>## CV SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk      Coef
## SL.rpart2_0_10_5_All     0.2002296 0.4719052
## SL.rpart2_0.01_10_5_All  0.2002296 0.0000000
## SL.rpart2_0_20_5_All     0.2110399 0.2280292
## SL.rpart2_0.01_20_5_All  0.2110399 0.0000000
## SL.rpart2_0_80_5_All     0.2485257 0.3000656
## SL.rpart2_0.01_80_5_All  0.2485257 0.0000000
## SL.rpart2_0_10_15_All    0.2002296 0.0000000
## SL.rpart2_0.01_10_15_All 0.2002296 0.0000000
## SL.rpart2_0_20_15_All    0.2110399 0.0000000
## SL.rpart2_0.01_20_15_All 0.2110399 0.0000000
## SL.rpart2_0_80_15_All    0.2485257 0.0000000
## SL.rpart2_0.01_80_15_All 0.2485257 0.0000000</code></pre>
<pre><code>## CV rpart_tune_All</code></pre>
<pre><code>## CV SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk      Coef
## SL.ranger_2_2_All   0.1484159 0.0000000
## SL.ranger_5_2_All   0.1509681 0.0000000
## SL.ranger_15_2_All  0.1511276 0.0000000
## SL.ranger_2_5_All   0.1280430 0.3394855
## SL.ranger_5_5_All   0.1282459 0.4267854
## SL.ranger_15_5_All  0.1423158 0.0000000
## SL.ranger_2_11_All  0.1313379 0.0000000
## SL.ranger_5_11_All  0.1286828 0.2337291
## SL.ranger_15_11_All 0.1360923 0.0000000</code></pre>
<pre><code>## CV rf_tune_All</code></pre>
<pre><code>## CV SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk Coef
## SL.xgboost_fast_250_2_0.05_All  0.2484451    0
## SL.xgboost_fast_1000_2_0.05_All 0.2484451    1
## SL.xgboost_fast_250_4_0.05_All  0.2484451    0
## SL.xgboost_fast_1000_4_0.05_All 0.2484451    0
## SL.xgboost_fast_250_2_0.2_All   0.2484451    0
## SL.xgboost_fast_1000_2_0.2_All  0.2484451    0
## SL.xgboost_fast_250_4_0.2_All   0.2484451    0
## SL.xgboost_fast_1000_4_0.2_All  0.2484451    0</code></pre>
<pre><code>## CV xgb_tune_All</code></pre>
<pre><code>## CV SL.xgboost_fast_All</code></pre>
<pre><code>## Non-Negative least squares convergence: TRUE</code></pre>
<pre><code>## full SL.mean_All</code></pre>
<pre><code>## Warning in predict.lm(fit, newdata = newX, type = &quot;response&quot;): prediction from a
## rank-deficient fit may be misleading</code></pre>
<pre><code>## full SL.lm2_All</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## full SL.glm2_All</code></pre>
<pre><code>## full SL.glmnet_fast_All</code></pre>
<pre><code>## full SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk      Coef
## SL.rpart2_0_10_5_All     0.2312208 0.0000000
## SL.rpart2_0.01_10_5_All  0.2264744 0.0000000
## SL.rpart2_0_20_5_All     0.1763329 0.3812911
## SL.rpart2_0.01_20_5_All  0.1809318 0.0000000
## SL.rpart2_0_80_5_All     0.1658675 0.6187089
## SL.rpart2_0.01_80_5_All  0.1658675 0.0000000
## SL.rpart2_0_10_15_All    0.2312208 0.0000000
## SL.rpart2_0.01_10_15_All 0.2264744 0.0000000
## SL.rpart2_0_20_15_All    0.1763329 0.0000000
## SL.rpart2_0.01_20_15_All 0.1809318 0.0000000
## SL.rpart2_0_80_15_All    0.1658675 0.0000000
## SL.rpart2_0.01_80_15_All 0.1658675 0.0000000</code></pre>
<pre><code>## full rpart_tune_All</code></pre>
<pre><code>## full SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk        Coef
## SL.ranger_2_2_All   0.1599222 0.000000000
## SL.ranger_5_2_All   0.1584222 0.000000000
## SL.ranger_15_2_All  0.1628434 0.000000000
## SL.ranger_2_5_All   0.1528761 0.004440179
## SL.ranger_5_5_All   0.1535367 0.000000000
## SL.ranger_15_5_All  0.1511217 0.995559821
## SL.ranger_2_11_All  0.1583693 0.000000000
## SL.ranger_5_11_All  0.1591777 0.000000000
## SL.ranger_15_11_All 0.1553593 0.000000000</code></pre>
<pre><code>## full rf_tune_All</code></pre>
<pre><code>## full SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk Coef
## SL.xgboost_fast_250_2_0.05_All  0.2481858    1
## SL.xgboost_fast_1000_2_0.05_All 0.2481858    0
## SL.xgboost_fast_250_4_0.05_All  0.2481858    0
## SL.xgboost_fast_1000_4_0.05_All 0.2481858    0
## SL.xgboost_fast_250_2_0.2_All   0.2481858    0
## SL.xgboost_fast_1000_2_0.2_All  0.2481858    0
## SL.xgboost_fast_250_4_0.2_All   0.2481858    0
## SL.xgboost_fast_1000_4_0.2_All  0.2481858    0</code></pre>
<pre><code>## full xgb_tune_All</code></pre>
<pre><code>## full SL.xgboost_fast_All</code></pre>
<pre><code>## Number of covariates in All is: 33</code></pre>
<pre><code>## CV SL.mean_All</code></pre>
<pre><code>## Warning in predict.lm(fit, newdata = newX, type = &quot;response&quot;): prediction from a
## rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.lm2_All</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.glm2_All</code></pre>
<pre><code>## CV SL.glmnet_fast_All</code></pre>
<pre><code>## Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =
## G$L, : Fitting terminated with step failure - check results carefully</code></pre>
<pre><code>## CV SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk      Coef
## SL.rpart2_0_10_5_All     0.2199991 0.4023428
## SL.rpart2_0.01_10_5_All  0.2199991 0.0000000
## SL.rpart2_0_20_5_All     0.2080325 0.2802087
## SL.rpart2_0.01_20_5_All  0.2080325 0.0000000
## SL.rpart2_0_80_5_All     0.2479737 0.3174485
## SL.rpart2_0.01_80_5_All  0.2479737 0.0000000
## SL.rpart2_0_10_15_All    0.2199991 0.0000000
## SL.rpart2_0.01_10_15_All 0.2199991 0.0000000
## SL.rpart2_0_20_15_All    0.2080325 0.0000000
## SL.rpart2_0.01_20_15_All 0.2080325 0.0000000
## SL.rpart2_0_80_15_All    0.2479737 0.0000000
## SL.rpart2_0.01_80_15_All 0.2479737 0.0000000</code></pre>
<pre><code>## CV rpart_tune_All</code></pre>
<pre><code>## CV SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk Coef
## SL.ranger_2_2_All   0.1595356    0
## SL.ranger_5_2_All   0.1561519    0
## SL.ranger_15_2_All  0.1686828    0
## SL.ranger_2_5_All   0.1351799    1
## SL.ranger_5_5_All   0.1382402    0
## SL.ranger_15_5_All  0.1509647    0
## SL.ranger_2_11_All  0.1440623    0
## SL.ranger_5_11_All  0.1440000    0
## SL.ranger_15_11_All 0.1532859    0</code></pre>
<pre><code>## CV rf_tune_All</code></pre>
<pre><code>## CV SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk Coef
## SL.xgboost_fast_250_2_0.05_All  0.2479319    1
## SL.xgboost_fast_1000_2_0.05_All 0.2479319    0
## SL.xgboost_fast_250_4_0.05_All  0.2479319    0
## SL.xgboost_fast_1000_4_0.05_All 0.2479319    0
## SL.xgboost_fast_250_2_0.2_All   0.2479319    0
## SL.xgboost_fast_1000_2_0.2_All  0.2479319    0
## SL.xgboost_fast_250_4_0.2_All   0.2479319    0
## SL.xgboost_fast_1000_4_0.2_All  0.2479319    0</code></pre>
<pre><code>## CV xgb_tune_All</code></pre>
<pre><code>## CV SL.xgboost_fast_All</code></pre>
<pre><code>## Number of covariates in All is: 33</code></pre>
<pre><code>## CV SL.mean_All</code></pre>
<pre><code>## Warning in predict.lm(fit, newdata = newX, type = &quot;response&quot;): prediction from a
## rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.lm2_All</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## CV SL.glm2_All</code></pre>
<pre><code>## CV SL.glmnet_fast_All</code></pre>
<pre><code>## Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =
## G$L, : Fitting terminated with step failure - check results carefully</code></pre>
<pre><code>## CV SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk       Coef
## SL.rpart2_0_10_5_All     0.2258783 0.56991485
## SL.rpart2_0.01_10_5_All  0.2258783 0.00000000
## SL.rpart2_0_20_5_All     0.2403511 0.02177855
## SL.rpart2_0.01_20_5_All  0.2403511 0.00000000
## SL.rpart2_0_80_5_All     0.2480521 0.40830660
## SL.rpart2_0.01_80_5_All  0.2480521 0.00000000
## SL.rpart2_0_10_15_All    0.2258783 0.00000000
## SL.rpart2_0.01_10_15_All 0.2258783 0.00000000
## SL.rpart2_0_20_15_All    0.2403511 0.00000000
## SL.rpart2_0.01_20_15_All 0.2403511 0.00000000
## SL.rpart2_0_80_15_All    0.2480521 0.00000000
## SL.rpart2_0.01_80_15_All 0.2480521 0.00000000</code></pre>
<pre><code>## CV rpart_tune_All</code></pre>
<pre><code>## CV SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk        Coef
## SL.ranger_2_2_All   0.1815163 0.000000000
## SL.ranger_5_2_All   0.1778897 0.004853019
## SL.ranger_15_2_All  0.1886354 0.000000000
## SL.ranger_2_5_All   0.1809942 0.000000000
## SL.ranger_5_5_All   0.1684264 0.995146981
## SL.ranger_15_5_All  0.1811368 0.000000000
## SL.ranger_2_11_All  0.1843232 0.000000000
## SL.ranger_5_11_All  0.1826941 0.000000000
## SL.ranger_15_11_All 0.1841492 0.000000000</code></pre>
<pre><code>## CV rf_tune_All</code></pre>
<pre><code>## CV SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk Coef
## SL.xgboost_fast_250_2_0.05_All  0.2480845    1
## SL.xgboost_fast_1000_2_0.05_All 0.2480845    0
## SL.xgboost_fast_250_4_0.05_All  0.2480845    0
## SL.xgboost_fast_1000_4_0.05_All 0.2480845    0
## SL.xgboost_fast_250_2_0.2_All   0.2480845    0
## SL.xgboost_fast_1000_2_0.2_All  0.2480845    0
## SL.xgboost_fast_250_4_0.2_All   0.2480845    0
## SL.xgboost_fast_1000_4_0.2_All  0.2480845    0</code></pre>
<pre><code>## CV xgb_tune_All</code></pre>
<pre><code>## CV SL.xgboost_fast_All</code></pre>
<pre><code>## Non-Negative least squares convergence: TRUE</code></pre>
<pre><code>## full SL.mean_All</code></pre>
<pre><code>## Warning in predict.lm(fit, newdata = newX, type = &quot;response&quot;): prediction from a
## rank-deficient fit may be misleading</code></pre>
<pre><code>## full SL.lm2_All</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## full SL.glm2_All</code></pre>
<pre><code>## full SL.glmnet_fast_All</code></pre>
<pre><code>## full SL.mgcv2_1_All</code></pre>
<pre><code>## Running rpart_tune
## Rpart tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 5L), obsWeights = obsWeights) 
## 
## 
##                               Risk      Coef
## SL.rpart2_0_10_5_All     0.2098700 0.0000000
## SL.rpart2_0.01_10_5_All  0.2098700 0.0000000
## SL.rpart2_0_20_5_All     0.1980541 0.0000000
## SL.rpart2_0.01_20_5_All  0.1980541 0.0000000
## SL.rpart2_0_80_5_All     0.1993456 0.4629797
## SL.rpart2_0.01_80_5_All  0.1993456 0.0000000
## SL.rpart2_0_10_15_All    0.1947496 0.5370203
## SL.rpart2_0.01_10_15_All 0.2044895 0.0000000
## SL.rpart2_0_20_15_All    0.1980541 0.0000000
## SL.rpart2_0.01_20_15_All 0.1980541 0.0000000
## SL.rpart2_0_80_15_All    0.1993456 0.0000000
## SL.rpart2_0.01_80_15_All 0.1993456 0.0000000</code></pre>
<pre><code>## full rpart_tune_All</code></pre>
<pre><code>## full SL.ranger_200_All</code></pre>
<pre><code>## Running rf_tune
## RF tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                          Risk     Coef
## SL.ranger_2_2_All   0.1585511 0.000000
## SL.ranger_5_2_All   0.1564458 0.000000
## SL.ranger_15_2_All  0.1612925 0.000000
## SL.ranger_2_5_All   0.1426208 0.875167
## SL.ranger_5_5_All   0.1437786 0.000000
## SL.ranger_15_5_All  0.1479854 0.000000
## SL.ranger_2_11_All  0.1441626 0.124833
## SL.ranger_5_11_All  0.1474295 0.000000
## SL.ranger_15_11_All 0.1472194 0.000000</code></pre>
<pre><code>## full rf_tune_All</code></pre>
<pre><code>## full SL.dbarts_200_All</code></pre>
<pre><code>## Running xgb_tune
## XGB tuned SL:
## 
## Call:  
## SuperLearner(Y = Y, X = X, newX = newX, family = family, SL.library = grid2$names,  
##     verbose = FALSE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L), obsWeights = obsWeights) 
## 
## 
##                                      Risk Coef
## SL.xgboost_fast_250_2_0.05_All  0.2478803    1
## SL.xgboost_fast_1000_2_0.05_All 0.2478803    0
## SL.xgboost_fast_250_4_0.05_All  0.2478803    0
## SL.xgboost_fast_1000_4_0.05_All 0.2478803    0
## SL.xgboost_fast_250_2_0.2_All   0.2478803    0
## SL.xgboost_fast_1000_2_0.2_All  0.2478803    0
## SL.xgboost_fast_250_4_0.2_All   0.2478803    0
## SL.xgboost_fast_1000_4_0.2_All  0.2478803    0</code></pre>
<pre><code>## full xgb_tune_All</code></pre>
<pre><code>## full SL.xgboost_fast_All</code></pre>
<pre><code>## 
## Call:  
## CV.SuperLearner(Y = data[[vars$outcomes[1]]], X = data[, vars$predictors],  
##     family = binomial(), SL.library = sl_lib, verbose = TRUE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = outer_cv_folds), innerCvControl = rep(list(SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L)), outer_cv_folds)) 
## 
## 
## Cross-validated predictions from the SuperLearner:  SL.predict 
## 
## Cross-validated predictions from the discrete super learner (cross-validation selector):  discreteSL.predict 
## 
## Which library algorithm was the discrete super learner:  whichDiscreteSL 
## 
## Cross-validated prediction for all algorithms in the library:  library.predict</code></pre>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb446-1"><a href="modeling.html#cb446-1"></a><span class="kw">save</span>(cvsl,</span>
<span id="cb446-2"><a href="modeling.html#cb446-2"></a>     <span class="dt">file =</span> <span class="st">&quot;data/estimator-cvsl.RData&quot;</span>)</span>
<span id="cb446-3"><a href="modeling.html#cb446-3"></a></span>
<span id="cb446-4"><a href="modeling.html#cb446-4"></a><span class="kw">summary</span>(cvsl)</span></code></pre></div>
<pre><code>## 
## Call:  
## CV.SuperLearner(Y = data[[vars$outcomes[1]]], X = data[, vars$predictors],  
##     family = binomial(), SL.library = sl_lib, verbose = TRUE, cvControl = SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = outer_cv_folds), innerCvControl = rep(list(SuperLearner.CV.control(stratifyCV = TRUE,  
##         V = 2L)), outer_cv_folds)) 
## 
## Risk is based on: Mean Squared Error
## 
## All risk estimates are based on V =  2 
## 
##            Algorithm     Ave        se     Min     Max
##        Super Learner 0.11574 0.0102761 0.10813 0.12335
##          Discrete SL 0.11752 0.0101137 0.11175 0.12329
##          SL.mean_All 0.24802 0.0025546 0.24789 0.24816
##           SL.lm2_All 0.11388 0.0102456 0.10917 0.11859
##          SL.glm2_All 0.15924 0.0174066 0.15381 0.16467
##   SL.glmnet_fast_All 0.11280 0.0117058 0.10880 0.11680
##       SL.mgcv2_1_All 0.16467 0.0176962 0.16385 0.16548
##       rpart_tune_All 0.18406 0.0152627 0.17467 0.19345
##    SL.ranger_200_All 0.13236 0.0101444 0.12557 0.13916
##          rf_tune_All 0.13502 0.0098337 0.12338 0.14666
##    SL.dbarts_200_All 0.11752 0.0101137 0.11175 0.12329
##         xgb_tune_All 0.14893 0.0123762 0.13641 0.16144
##  SL.xgboost_fast_All 0.15166 0.0126596 0.13714 0.16618</code></pre>
<div id="ensemble-weights" class="section level3">
<h3><span class="header-section-number">6.3.1</span> Ensemble weights</h3>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb448-1"><a href="modeling.html#cb448-1"></a><span class="co"># Review weight distribution.</span></span>
<span id="cb448-2"><a href="modeling.html#cb448-2"></a>(<span class="dt">weight_tab =</span> ck37r<span class="op">::</span><span class="kw">cvsl_weights</span>(cvsl))</span></code></pre></div>
<pre><code>##     #      Learner    Mean      SD     Min     Max
## 1   1   dbarts_200 0.75463 0.23340 0.58959 0.91967
## 2   2  glmnet_fast 0.20520 0.29020 0.00000 0.41041
## 3   3   ranger_200 0.02775 0.03924 0.00000 0.05550
## 4   4         glm2 0.01241 0.01756 0.00000 0.02483
## 5   5         mean 0.00000 0.00000 0.00000 0.00000
## 6   6          lm2 0.00000 0.00000 0.00000 0.00000
## 7   7      mgcv2_1 0.00000 0.00000 0.00000 0.00000
## 8   8   rpart_tune 0.00000 0.00000 0.00000 0.00000
## 9   9      rf_tune 0.00000 0.00000 0.00000 0.00000
## 10 10     xgb_tune 0.00000 0.00000 0.00000 0.00000
## 11 11 xgboost_fast 0.00000 0.00000 0.00000 0.00000</code></pre>
<div class="sourceCode" id="cb450"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb450-1"><a href="modeling.html#cb450-1"></a><span class="co"># Remove algorithms with 0 weight.</span></span>
<span id="cb450-2"><a href="modeling.html#cb450-2"></a>(<span class="dt">weight_tab =</span> weight_tab[weight_tab<span class="op">$</span>Max <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ])</span></code></pre></div>
<pre><code>##   #     Learner    Mean      SD     Min     Max
## 1 1  dbarts_200 0.75463 0.23340 0.58959 0.91967
## 2 2 glmnet_fast 0.20520 0.29020 0.00000 0.41041
## 3 3  ranger_200 0.02775 0.03924 0.00000 0.05550
## 4 4        glm2 0.01241 0.01756 0.00000 0.02483</code></pre>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb452-1"><a href="modeling.html#cb452-1"></a><span class="kw">cat</span>(<span class="kw">kable</span>(weight_tab, <span class="dt">digits =</span> <span class="dv">4</span>, <span class="dt">format =</span> <span class="st">&quot;latex&quot;</span>, <span class="dt">booktabs =</span> <span class="ot">TRUE</span>,</span>
<span id="cb452-2"><a href="modeling.html#cb452-2"></a>          <span class="dt">label =</span> <span class="st">&quot;cvsl-weights&quot;</span>,</span>
<span id="cb452-3"><a href="modeling.html#cb452-3"></a>          <span class="dt">row.names =</span> <span class="ot">FALSE</span>,</span>
<span id="cb452-4"><a href="modeling.html#cb452-4"></a>          <span class="dt">caption =</span> <span class="st">&quot;Distribution of algorithm weights across ensemble cross-validation replications&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb452-5"><a href="modeling.html#cb452-5"></a><span class="st">      </span><span class="kw">kable_styling</span>(<span class="dt">latex_options =</span> <span class="st">&quot;hold_position&quot;</span>),</span>
<span id="cb452-6"><a href="modeling.html#cb452-6"></a>      <span class="dt">file =</span> <span class="st">&quot;tables/cvsl-weight-table.tex&quot;</span>)</span></code></pre></div>
</div>
<div id="auc-analysis" class="section level3">
<h3><span class="header-section-number">6.3.2</span> AUC analysis</h3>
<div class="sourceCode" id="cb453"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb453-1"><a href="modeling.html#cb453-1"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb453-2"><a href="modeling.html#cb453-2"></a><span class="kw">library</span>(ck37r)</span>
<span id="cb453-3"><a href="modeling.html#cb453-3"></a></span>
<span id="cb453-4"><a href="modeling.html#cb453-4"></a><span class="co">######</span></span>
<span id="cb453-5"><a href="modeling.html#cb453-5"></a><span class="co"># AUC analysis</span></span>
<span id="cb453-6"><a href="modeling.html#cb453-6"></a></span>
<span id="cb453-7"><a href="modeling.html#cb453-7"></a>(<span class="dt">auc_tab =</span> <span class="kw">auc_table</span>(cvsl))</span></code></pre></div>
<pre><code>##                           auc         se  ci_lower  ci_upper      p-value
## SL.mean_All         0.5000000 0.05767800 0.3869532 0.6130468 1.582959e-13
## rpart_tune_All      0.7887063 0.03435854 0.7213648 0.8560478 6.400740e-05
## SL.mgcv2_1_All      0.8368735 0.02542988 0.7870318 0.8867151 5.172679e-04
## SL.xgboost_fast_All 0.8565402 0.02169579 0.8140172 0.8990631 1.645421e-03
## SL.glm2_All         0.8599265 0.02240240 0.8160185 0.9038344 3.516119e-03
## xgb_tune_All        0.8622278 0.02144475 0.8201969 0.9042588 3.380814e-03
## rf_tune_All         0.8926853 0.01803672 0.8573339 0.9280366 6.282675e-02
## SL.ranger_200_All   0.8975765 0.01761040 0.8630608 0.9320923 9.838723e-02
## SL.dbarts_200_All   0.9159608 0.01627180 0.8840686 0.9478529 3.946726e-01
## DiscreteSL          0.9159608 0.01627180 0.8840686 0.9478529 3.946726e-01
## SL.glmnet_fast_All  0.9166283 0.01659627 0.8841002 0.9491564 4.122684e-01
## SuperLearner        0.9171106 0.01637241 0.8850213 0.9492000 4.225844e-01
## SL.lm2_All          0.9203080 0.01685427 0.8872742 0.9533417 5.000000e-01</code></pre>
<div class="sourceCode" id="cb455"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb455-1"><a href="modeling.html#cb455-1"></a><span class="co"># Drop p-value column.</span></span>
<span id="cb455-2"><a href="modeling.html#cb455-2"></a>auc_tab2 =<span class="st"> </span>auc_tab[, <span class="op">!</span><span class="kw">names</span>(auc_tab) <span class="op">%in%</span><span class="st"> &quot;p-value&quot;</span>]</span>
<span id="cb455-3"><a href="modeling.html#cb455-3"></a></span>
<span id="cb455-4"><a href="modeling.html#cb455-4"></a><span class="co"># Convert rownames to learner column.</span></span>
<span id="cb455-5"><a href="modeling.html#cb455-5"></a>auc_tab2<span class="op">$</span>learner =<span class="st"> </span><span class="kw">rownames</span>(auc_tab2)</span>
<span id="cb455-6"><a href="modeling.html#cb455-6"></a></span>
<span id="cb455-7"><a href="modeling.html#cb455-7"></a><span class="co"># Move learner column to the beginning.</span></span>
<span id="cb455-8"><a href="modeling.html#cb455-8"></a>(<span class="dt">auc_tab2 =</span> <span class="kw">cbind</span>(<span class="dt">learner =</span> auc_tab2<span class="op">$</span>learner,</span>
<span id="cb455-9"><a href="modeling.html#cb455-9"></a>                  auc_tab2[, <span class="op">!</span><span class="kw">names</span>(auc_tab2) <span class="op">%in%</span><span class="st"> &quot;learner&quot;</span>]))</span></code></pre></div>
<pre><code>##                                 learner       auc         se  ci_lower
## SL.mean_All                 SL.mean_All 0.5000000 0.05767800 0.3869532
## rpart_tune_All           rpart_tune_All 0.7887063 0.03435854 0.7213648
## SL.mgcv2_1_All           SL.mgcv2_1_All 0.8368735 0.02542988 0.7870318
## SL.xgboost_fast_All SL.xgboost_fast_All 0.8565402 0.02169579 0.8140172
## SL.glm2_All                 SL.glm2_All 0.8599265 0.02240240 0.8160185
## xgb_tune_All               xgb_tune_All 0.8622278 0.02144475 0.8201969
## rf_tune_All                 rf_tune_All 0.8926853 0.01803672 0.8573339
## SL.ranger_200_All     SL.ranger_200_All 0.8975765 0.01761040 0.8630608
## SL.dbarts_200_All     SL.dbarts_200_All 0.9159608 0.01627180 0.8840686
## DiscreteSL                   DiscreteSL 0.9159608 0.01627180 0.8840686
## SL.glmnet_fast_All   SL.glmnet_fast_All 0.9166283 0.01659627 0.8841002
## SuperLearner               SuperLearner 0.9171106 0.01637241 0.8850213
## SL.lm2_All                   SL.lm2_All 0.9203080 0.01685427 0.8872742
##                      ci_upper
## SL.mean_All         0.6130468
## rpart_tune_All      0.8560478
## SL.mgcv2_1_All      0.8867151
## SL.xgboost_fast_All 0.8990631
## SL.glm2_All         0.9038344
## xgb_tune_All        0.9042588
## rf_tune_All         0.9280366
## SL.ranger_200_All   0.9320923
## SL.dbarts_200_All   0.9478529
## DiscreteSL          0.9478529
## SL.glmnet_fast_All  0.9491564
## SuperLearner        0.9492000
## SL.lm2_All          0.9533417</code></pre>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb457-1"><a href="modeling.html#cb457-1"></a><span class="kw">colnames</span>(auc_tab2)[<span class="dv">1</span>] =<span class="st"> &quot;learner&quot;</span></span>
<span id="cb457-2"><a href="modeling.html#cb457-2"></a><span class="kw">rownames</span>(auc_tab2) =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb457-3"><a href="modeling.html#cb457-3"></a></span>
<span id="cb457-4"><a href="modeling.html#cb457-4"></a><span class="co"># Skip SL.mean - it&#39;s too low to be worth plotting.</span></span>
<span id="cb457-5"><a href="modeling.html#cb457-5"></a><span class="kw">plot_table</span>(auc_tab2[<span class="op">-</span><span class="dv">1</span>, ]) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Cross-validated ROC-AUC&quot;</span>)</span></code></pre></div>
<p><img src="data-science-in-r_files/figure-html/cvsl_auc-1.png" width="672" /></p>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb458-1"><a href="modeling.html#cb458-1"></a><span class="kw">ggsave</span>(<span class="st">&quot;visuals/cvsl-roc-auc-comparison.pdf&quot;</span>)</span></code></pre></div>
<pre><code>## Saving 7 x 5 in image</code></pre>
<div class="sourceCode" id="cb460"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb460-1"><a href="modeling.html#cb460-1"></a><span class="kw">plot_roc</span>(cvsl)</span></code></pre></div>
<p><img src="data-science-in-r_files/figure-html/cvsl_auc-2.png" width="672" /></p>
<div class="sourceCode" id="cb461"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb461-1"><a href="modeling.html#cb461-1"></a><span class="kw">ggsave</span>(<span class="st">&quot;visuals/cvsl-roc.pdf&quot;</span>)</span></code></pre></div>
<pre><code>## Saving 7 x 5 in image</code></pre>
<div class="sourceCode" id="cb463"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb463-1"><a href="modeling.html#cb463-1"></a><span class="kw">names</span>(auc_tab2)</span></code></pre></div>
<pre><code>## [1] &quot;learner&quot;  &quot;auc&quot;      &quot;se&quot;       &quot;ci_lower&quot; &quot;ci_upper&quot;</code></pre>
<div class="sourceCode" id="cb465"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb465-1"><a href="modeling.html#cb465-1"></a><span class="kw">names</span>(auc_tab2) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Learner&quot;</span>, <span class="st">&quot;ROC-AUC&quot;</span>, <span class="st">&quot;Std. Err.&quot;</span>, <span class="st">&quot;CI Lower&quot;</span>, <span class="st">&quot;CI Upper&quot;</span>)</span>
<span id="cb465-2"><a href="modeling.html#cb465-2"></a></span>
<span id="cb465-3"><a href="modeling.html#cb465-3"></a><span class="kw">cat</span>(<span class="kw">kable</span>(auc_tab2, <span class="dt">digits =</span> <span class="dv">4</span>, <span class="dt">format =</span> <span class="st">&quot;latex&quot;</span>, <span class="dt">booktabs =</span> <span class="ot">TRUE</span>,</span>
<span id="cb465-4"><a href="modeling.html#cb465-4"></a>          <span class="dt">label =</span> <span class="st">&quot;cvsl-auc&quot;</span>,</span>
<span id="cb465-5"><a href="modeling.html#cb465-5"></a>          <span class="dt">caption =</span> <span class="st">&quot;Cross-validated ROC-AUC discrimination performance&quot;</span>),</span>
<span id="cb465-6"><a href="modeling.html#cb465-6"></a>      <span class="dt">file =</span> <span class="st">&quot;tables/cvsl-auc_table.tex&quot;</span>)</span></code></pre></div>
</div>
<div id="precision-recall-analysis" class="section level3">
<h3><span class="header-section-number">6.3.3</span> Precision-Recall analysis</h3>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb466-1"><a href="modeling.html#cb466-1"></a><span class="co">######</span></span>
<span id="cb466-2"><a href="modeling.html#cb466-2"></a><span class="co"># Precision-Recall analysis</span></span>
<span id="cb466-3"><a href="modeling.html#cb466-3"></a></span>
<span id="cb466-4"><a href="modeling.html#cb466-4"></a>(<span class="dt">prauc_tab =</span> <span class="kw">prauc_table</span>(cvsl))</span></code></pre></div>
<pre><code>##                         prauc      stderr  ci_lower  ci_upper
## SL.mean_All         0.5445495 0.001503137 0.5416033 0.5474956
## rpart_tune_All      0.7989240 0.002566970 0.7938927 0.8039552
## SL.mgcv2_1_All      0.8131151 0.011315743 0.7909362 0.8352940
## SL.glm2_All         0.8432754 0.012871382 0.8180475 0.8685033
## SL.xgboost_fast_All 0.8657094 0.005130902 0.8556529 0.8757660
## xgb_tune_All        0.8672148 0.009362066 0.8488651 0.8855644
## rf_tune_All         0.9089016 0.004028301 0.9010061 0.9167971
## SL.ranger_200_All   0.9140923 0.001131961 0.9118736 0.9163109
## SL.glmnet_fast_All  0.9200184 0.019765525 0.8812780 0.9587588
## SuperLearner        0.9218614 0.015730351 0.8910299 0.9526929
## SL.lm2_All          0.9222696 0.016925163 0.8890962 0.9554429
## SL.dbarts_200_All   0.9229947 0.014703303 0.8941762 0.9518131
## DiscreteSL          0.9229947 0.014703303 0.8941762 0.9518131</code></pre>
<div class="sourceCode" id="cb468"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb468-1"><a href="modeling.html#cb468-1"></a>prauc_tab<span class="op">$</span>learner =<span class="st"> </span><span class="kw">rownames</span>(prauc_tab)</span>
<span id="cb468-2"><a href="modeling.html#cb468-2"></a><span class="kw">rownames</span>(prauc_tab) =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb468-3"><a href="modeling.html#cb468-3"></a></span>
<span id="cb468-4"><a href="modeling.html#cb468-4"></a><span class="co"># Move learner column to the beginning.</span></span>
<span id="cb468-5"><a href="modeling.html#cb468-5"></a>(<span class="dt">prauc_tab =</span> <span class="kw">cbind</span>(<span class="dt">learner =</span> prauc_tab<span class="op">$</span>learner,</span>
<span id="cb468-6"><a href="modeling.html#cb468-6"></a>                   prauc_tab[, <span class="op">!</span><span class="kw">names</span>(prauc_tab) <span class="op">%in%</span><span class="st"> &quot;learner&quot;</span>]))</span></code></pre></div>
<pre><code>##                learner     prauc      stderr  ci_lower  ci_upper
## 1          SL.mean_All 0.5445495 0.001503137 0.5416033 0.5474956
## 2       rpart_tune_All 0.7989240 0.002566970 0.7938927 0.8039552
## 3       SL.mgcv2_1_All 0.8131151 0.011315743 0.7909362 0.8352940
## 4          SL.glm2_All 0.8432754 0.012871382 0.8180475 0.8685033
## 5  SL.xgboost_fast_All 0.8657094 0.005130902 0.8556529 0.8757660
## 6         xgb_tune_All 0.8672148 0.009362066 0.8488651 0.8855644
## 7          rf_tune_All 0.9089016 0.004028301 0.9010061 0.9167971
## 8    SL.ranger_200_All 0.9140923 0.001131961 0.9118736 0.9163109
## 9   SL.glmnet_fast_All 0.9200184 0.019765525 0.8812780 0.9587588
## 10        SuperLearner 0.9218614 0.015730351 0.8910299 0.9526929
## 11          SL.lm2_All 0.9222696 0.016925163 0.8890962 0.9554429
## 12   SL.dbarts_200_All 0.9229947 0.014703303 0.8941762 0.9518131
## 13          DiscreteSL 0.9229947 0.014703303 0.8941762 0.9518131</code></pre>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb470-1"><a href="modeling.html#cb470-1"></a><span class="kw">plot_table</span>(prauc_tab, <span class="dt">metric =</span> <span class="st">&quot;prauc&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Cross-validated PR-AUC&quot;</span>)</span></code></pre></div>
<p><img src="data-science-in-r_files/figure-html/cvsl_prauc-1.png" width="672" /></p>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb471-1"><a href="modeling.html#cb471-1"></a><span class="kw">ggsave</span>(<span class="st">&quot;visuals/cvsl-prauc-comparison.pdf&quot;</span>)</span></code></pre></div>
<pre><code>## Saving 7 x 5 in image</code></pre>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb473-1"><a href="modeling.html#cb473-1"></a><span class="co">################</span></span>
<span id="cb473-2"><a href="modeling.html#cb473-2"></a><span class="co"># Precision-recall curve comparison.</span></span>
<span id="cb473-3"><a href="modeling.html#cb473-3"></a></span>
<span id="cb473-4"><a href="modeling.html#cb473-4"></a>pred_lib =<span class="st"> </span><span class="kw">data.frame</span>(cvsl<span class="op">$</span>library.predict)</span>
<span id="cb473-5"><a href="modeling.html#cb473-5"></a></span>
<span id="cb473-6"><a href="modeling.html#cb473-6"></a><span class="kw">names</span>(pred_lib) =<span class="st"> </span>cvsl<span class="op">$</span>libraryNames</span>
<span id="cb473-7"><a href="modeling.html#cb473-7"></a>pred_df =<span class="st"> </span>pred_lib</span>
<span id="cb473-8"><a href="modeling.html#cb473-8"></a></span>
<span id="cb473-9"><a href="modeling.html#cb473-9"></a><span class="kw">summary</span>(pred_df)</span></code></pre></div>
<pre><code>##   SL.mean_All       SL.lm2_All      SL.glm2_All     SL.glmnet_fast_All
##  Min.   :0.5430   Min.   :0.0000   Min.   :0.0000   Min.   :0.002291  
##  1st Qu.:0.5430   1st Qu.:0.2252   1st Qu.:0.0153   1st Qu.:0.139768  
##  Median :0.5430   Median :0.5823   Median :0.6291   Median :0.616401  
##  Mean   :0.5445   Mean   :0.5364   Mean   :0.5128   Mean   :0.533499  
##  3rd Qu.:0.5461   3rd Qu.:0.8664   3rd Qu.:0.9745   3rd Qu.:0.903847  
##  Max.   :0.5461   Max.   :1.0000   Max.   :1.0000   Max.   :0.995543  
##  SL.mgcv2_1_All    rpart_tune_All    SL.ranger_200_All  rf_tune_All     
##  Min.   :0.00000   Min.   :0.05936   Min.   :0.00665   Min.   :0.01191  
##  1st Qu.:0.01362   1st Qu.:0.20312   1st Qu.:0.25080   1st Qu.:0.27727  
##  Median :0.66733   Median :0.63368   Median :0.55285   Median :0.54753  
##  Mean   :0.52910   Mean   :0.53916   Mean   :0.53629   Mean   :0.53495  
##  3rd Qu.:0.98181   3rd Qu.:0.85643   3rd Qu.:0.83460   3rd Qu.:0.81306  
##  Max.   :1.00000   Max.   :0.96970   Max.   :0.99217   Max.   :0.98669  
##  SL.dbarts_200_All  xgb_tune_All     SL.xgboost_fast_All
##  Min.   :0.01777   Min.   :0.05946   Min.   :0.05113    
##  1st Qu.:0.22435   1st Qu.:0.20156   1st Qu.:0.19636    
##  Median :0.58495   Median :0.56314   Median :0.55752    
##  Mean   :0.53911   Mean   :0.53977   Mean   :0.53697    
##  3rd Qu.:0.85516   3rd Qu.:0.85621   3rd Qu.:0.86247    
##  Max.   :0.98518   Max.   :0.95030   Max.   :0.98142</code></pre>
<div class="sourceCode" id="cb475"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb475-1"><a href="modeling.html#cb475-1"></a><span class="co"># Add on the SuperLearner prediction.</span></span>
<span id="cb475-2"><a href="modeling.html#cb475-2"></a>pred_df<span class="op">$</span>SuperLearner =<span class="st"> </span>cvsl<span class="op">$</span>SL.predict</span>
<span id="cb475-3"><a href="modeling.html#cb475-3"></a></span>
<span id="cb475-4"><a href="modeling.html#cb475-4"></a><span class="kw">library</span>(precrec)</span>
<span id="cb475-5"><a href="modeling.html#cb475-5"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb475-6"><a href="modeling.html#cb475-6"></a></span>
<span id="cb475-7"><a href="modeling.html#cb475-7"></a>(<span class="dt">sscurves =</span> <span class="kw">evalmod</span>(<span class="dt">scores =</span> pred_df,</span>
<span id="cb475-8"><a href="modeling.html#cb475-8"></a>                    <span class="dt">labels =</span> cvsl<span class="op">$</span>Y,</span>
<span id="cb475-9"><a href="modeling.html#cb475-9"></a>                    <span class="dt">modnames =</span> <span class="kw">names</span>(pred_df)))</span></code></pre></div>
<pre><code>## 
##     === AUCs ===
## 
##               Model name Dataset ID Curve type       AUC
##    1         SL.mean_All          1        ROC 0.4984848
##    2         SL.mean_All          1        PRC 0.5435123
##    3          SL.lm2_All          1        ROC 0.9207290
##    4          SL.lm2_All          1        PRC 0.9193685
##    5         SL.glm2_All          1        ROC 0.8586737
##    6         SL.glm2_All          1        PRC 0.8443813
##    7  SL.glmnet_fast_All          1        ROC 0.9157664
##    8  SL.glmnet_fast_All          1        PRC 0.9174906
##    9      SL.mgcv2_1_All          1        ROC 0.8355292
##   10      SL.mgcv2_1_All          1        PRC 0.8094916
##   11      rpart_tune_All          1        ROC 0.7879666
##   12      rpart_tune_All          1        PRC 0.7911882
##   13   SL.ranger_200_All          1        ROC 0.8955204
##   14   SL.ranger_200_All          1        PRC 0.9130445
##   15         rf_tune_All          1        ROC 0.8934124
##   16         rf_tune_All          1        PRC 0.9078671
##   17   SL.dbarts_200_All          1        ROC 0.9150637
##   18   SL.dbarts_200_All          1        PRC 0.9165212
##   19        xgb_tune_All          1        ROC 0.8628678
##   20        xgb_tune_All          1        PRC 0.8712067
##   21 SL.xgboost_fast_All          1        ROC 0.8579491
##   22 SL.xgboost_fast_All          1        PRC 0.8640953
##   23        SuperLearner          1        ROC 0.9168643
##   24        SuperLearner          1        PRC 0.9148774
## 
## 
##     === Input data ===
## 
##               Model name Dataset ID # of negatives # of positives
##    1         SL.mean_All          1            138            165
##    2          SL.lm2_All          1            138            165
##    3         SL.glm2_All          1            138            165
##    4  SL.glmnet_fast_All          1            138            165
##    5      SL.mgcv2_1_All          1            138            165
##    6      rpart_tune_All          1            138            165
##    7   SL.ranger_200_All          1            138            165
##    8         rf_tune_All          1            138            165
##    9   SL.dbarts_200_All          1            138            165
##   10        xgb_tune_All          1            138            165
##   11 SL.xgboost_fast_All          1            138            165
##   12        SuperLearner          1            138            165</code></pre>
<div class="sourceCode" id="cb477"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb477-1"><a href="modeling.html#cb477-1"></a><span class="co"># Show a Precision-Recall plot comparing all estimators.</span></span>
<span id="cb477-2"><a href="modeling.html#cb477-2"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: subset this one and improve legend placement.</span></span>
<span id="cb477-3"><a href="modeling.html#cb477-3"></a><span class="kw">autoplot</span>(sscurves, <span class="st">&quot;PRC&quot;</span>) <span class="op">+</span></span>
<span id="cb477-4"><a href="modeling.html#cb477-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></span>
<span id="cb477-5"><a href="modeling.html#cb477-5"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="fl">0.65</span>, <span class="fl">0.65</span>),</span>
<span id="cb477-6"><a href="modeling.html#cb477-6"></a>        <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">8</span>), <span class="co">#face = &quot;bold&quot;),</span></span>
<span id="cb477-7"><a href="modeling.html#cb477-7"></a>        <span class="dt">legend.margin =</span> <span class="kw">margin</span>(<span class="dt">l =</span> <span class="fl">0.2</span>, <span class="dt">r =</span> <span class="fl">0.2</span>, <span class="dt">b =</span> <span class="fl">0.2</span>, <span class="dt">unit =</span> <span class="st">&quot;cm&quot;</span>),</span>
<span id="cb477-8"><a href="modeling.html#cb477-8"></a>        <span class="dt">legend.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="kw">alpha</span>(<span class="st">&quot;gray95&quot;</span>, <span class="fl">0.8</span>),</span>
<span id="cb477-9"><a href="modeling.html#cb477-9"></a>                                         <span class="dt">color =</span> <span class="st">&quot;gray80&quot;</span>),</span>
<span id="cb477-10"><a href="modeling.html#cb477-10"></a>        <span class="dt">legend.key =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<p><img src="data-science-in-r_files/figure-html/cvsl_prauc-2.png" width="672" /></p>
<div class="sourceCode" id="cb478"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb478-1"><a href="modeling.html#cb478-1"></a><span class="kw">ggsave</span>(<span class="st">&quot;visuals/prc-comparison.pdf&quot;</span>,</span>
<span id="cb478-2"><a href="modeling.html#cb478-2"></a>       <span class="dt">width =</span> <span class="dv">4</span>, <span class="dt">height =</span> <span class="dv">4</span>)</span>
<span id="cb478-3"><a href="modeling.html#cb478-3"></a></span>
<span id="cb478-4"><a href="modeling.html#cb478-4"></a></span>
<span id="cb478-5"><a href="modeling.html#cb478-5"></a><span class="co">################</span></span>
<span id="cb478-6"><a href="modeling.html#cb478-6"></a><span class="co"># PR-AUC table</span></span>
<span id="cb478-7"><a href="modeling.html#cb478-7"></a><span class="kw">names</span>(prauc_tab) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Learner&quot;</span>, <span class="st">&quot;PR-AUC&quot;</span>, <span class="st">&quot;Std. Err.&quot;</span>, <span class="st">&quot;CI Lower&quot;</span>, <span class="st">&quot;CI Upper&quot;</span>)</span>
<span id="cb478-8"><a href="modeling.html#cb478-8"></a></span>
<span id="cb478-9"><a href="modeling.html#cb478-9"></a><span class="kw">cat</span>(<span class="kw">kable</span>(prauc_tab, <span class="dt">digits =</span> <span class="dv">4</span>, <span class="dt">format =</span> <span class="st">&quot;latex&quot;</span>, <span class="dt">booktabs =</span> <span class="ot">TRUE</span>,</span>
<span id="cb478-10"><a href="modeling.html#cb478-10"></a>          <span class="dt">label =</span> <span class="st">&quot;cvsl-prauc&quot;</span>,</span>
<span id="cb478-11"><a href="modeling.html#cb478-11"></a>          <span class="dt">caption =</span> <span class="st">&quot;Cross-validated PR-AUC discrimination performance&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb478-12"><a href="modeling.html#cb478-12"></a><span class="st">      </span><span class="kw">kable_styling</span>(<span class="dt">latex_options =</span> <span class="st">&quot;hold_position&quot;</span>),</span>
<span id="cb478-13"><a href="modeling.html#cb478-13"></a>      <span class="dt">file =</span> <span class="st">&quot;tables/cvsl-prauc_table.tex&quot;</span>)</span></code></pre></div>
</div>
<div id="brier-score" class="section level3">
<h3><span class="header-section-number">6.3.4</span> Brier score</h3>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb479-1"><a href="modeling.html#cb479-1"></a><span class="co">##########################</span></span>
<span id="cb479-2"><a href="modeling.html#cb479-2"></a><span class="co"># Brier score table.</span></span>
<span id="cb479-3"><a href="modeling.html#cb479-3"></a></span>
<span id="cb479-4"><a href="modeling.html#cb479-4"></a>(<span class="dt">brier_tab =</span> ck37r<span class="op">::</span><span class="kw">brier_table</span>(cvsl))</span></code></pre></div>
<pre><code>##                         brier       stderr  ci_lower  ci_upper
## SL.mean_All         0.2480221 0.0001339280 0.2477596 0.2482846
## rpart_tune_All      0.1840604 0.0093869313 0.1656620 0.2024588
## SL.mgcv2_1_All      0.1646688 0.0008143654 0.1630727 0.1662650
## SL.glm2_All         0.1592401 0.0054333149 0.1485908 0.1698894
## SL.xgboost_fast_All 0.1516585 0.0145181452 0.1232029 0.1801141
## xgb_tune_All        0.1489275 0.0125172917 0.1243936 0.1734614
## rf_tune_All         0.1350198 0.0116438189 0.1121979 0.1578417
## SL.ranger_200_All   0.1323632 0.0067966648 0.1190417 0.1456847
## SL.dbarts_200_All   0.1175203 0.0057694833 0.1062121 0.1288285
## DiscreteSL          0.1175203 0.0057694833 0.1062121 0.1288285
## SuperLearner        0.1157416 0.0076113337 0.1008234 0.1306598
## SL.lm2_All          0.1138816 0.0047130518 0.1046440 0.1231192
## SL.glmnet_fast_All  0.1127997 0.0040007360 0.1049583 0.1206412</code></pre>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb481-1"><a href="modeling.html#cb481-1"></a><span class="kw">names</span>(brier_tab) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Brier score&quot;</span>, <span class="st">&quot;Std. Err.&quot;</span>, <span class="st">&quot;CI Lower&quot;</span>, <span class="st">&quot;CI Upper&quot;</span>)</span>
<span id="cb481-2"><a href="modeling.html#cb481-2"></a></span>
<span id="cb481-3"><a href="modeling.html#cb481-3"></a>brier_tab =<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">Learner =</span> <span class="kw">rownames</span>(brier_tab), brier_tab)</span>
<span id="cb481-4"><a href="modeling.html#cb481-4"></a></span>
<span id="cb481-5"><a href="modeling.html#cb481-5"></a><span class="kw">rownames</span>(brier_tab) =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb481-6"><a href="modeling.html#cb481-6"></a></span>
<span id="cb481-7"><a href="modeling.html#cb481-7"></a><span class="kw">cat</span>(<span class="kw">kable</span>(brier_tab, <span class="dt">digits =</span> <span class="dv">5</span>, <span class="dt">format =</span> <span class="st">&quot;latex&quot;</span>, <span class="dt">booktabs =</span> <span class="ot">TRUE</span>,</span>
<span id="cb481-8"><a href="modeling.html#cb481-8"></a>          <span class="dt">label =</span> <span class="st">&quot;cvsl-brier&quot;</span>,</span>
<span id="cb481-9"><a href="modeling.html#cb481-9"></a>          <span class="dt">row.names =</span> <span class="ot">FALSE</span>,</span>
<span id="cb481-10"><a href="modeling.html#cb481-10"></a>          <span class="dt">caption =</span> <span class="st">&quot;Cross-validated Brier score for each learner and the ensemble&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb481-11"><a href="modeling.html#cb481-11"></a><span class="st">      </span><span class="kw">kable_styling</span>(<span class="dt">latex_options =</span> <span class="st">&quot;hold_position&quot;</span>),</span>
<span id="cb481-12"><a href="modeling.html#cb481-12"></a>      <span class="dt">file =</span> <span class="st">&quot;tables/cvsl-brier-table.tex&quot;</span>)</span></code></pre></div>
</div>
<div id="index-of-prediction-accuracy" class="section level3">
<h3><span class="header-section-number">6.3.5</span> Index of prediction accuracy</h3>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb482-1"><a href="modeling.html#cb482-1"></a><span class="co">##########################</span></span>
<span id="cb482-2"><a href="modeling.html#cb482-2"></a><span class="co"># Index of prediction accuracy table.</span></span>
<span id="cb482-3"><a href="modeling.html#cb482-3"></a></span>
<span id="cb482-4"><a href="modeling.html#cb482-4"></a>(<span class="dt">ipa_tab =</span> ck37r<span class="op">::</span><span class="kw">ipa_table</span>(cvsl))</span></code></pre></div>
<pre><code>##                               ipa       stderr      ci_lower      ci_upper
## SL.mean_All         -3.644036e-05 1.967793e-08 -3.647893e-05 -3.640179e-05
## rpart_tune_All       2.578395e-01 3.824930e-02  1.828709e-01  3.328081e-01
## SL.mgcv2_1_All       3.360494e-01 2.925023e-03  3.303163e-01  3.417824e-01
## SL.glm2_All          3.579247e-01 2.225410e-02  3.143067e-01  4.015427e-01
## SL.xgboost_fast_All  3.884743e-01 5.886805e-02  2.730929e-01  5.038556e-01
## xgb_tune_All         3.994901e-01 5.079457e-02  2.999327e-01  4.990474e-01
## rf_tune_All          4.555686e-01 4.724240e-02  3.629735e-01  5.481637e-01
## SL.ranger_200_All    4.662906e-01 2.769267e-02  4.120130e-01  5.205682e-01
## SL.dbarts_200_All    5.261401e-01 2.351870e-02  4.800434e-01  5.722368e-01
## DiscreteSL           5.261401e-01 2.351870e-02  4.800434e-01  5.722368e-01
## SuperLearner         5.333079e-01 3.094126e-02  4.726631e-01  5.939528e-01
## SL.lm2_All           5.408138e-01 1.925120e-02  5.030814e-01  5.785461e-01
## SL.glmnet_fast_All   5.451776e-01 1.637675e-02  5.130792e-01  5.772760e-01</code></pre>
<div class="sourceCode" id="cb484"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb484-1"><a href="modeling.html#cb484-1"></a><span class="kw">names</span>(ipa_tab) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;IPA&quot;</span>, <span class="st">&quot;Std. Err.&quot;</span>, <span class="st">&quot;CI Lower&quot;</span>, <span class="st">&quot;CI Upper&quot;</span>)</span>
<span id="cb484-2"><a href="modeling.html#cb484-2"></a></span>
<span id="cb484-3"><a href="modeling.html#cb484-3"></a>ipa_tab =<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">Learner =</span> <span class="kw">rownames</span>(ipa_tab), ipa_tab)</span>
<span id="cb484-4"><a href="modeling.html#cb484-4"></a></span>
<span id="cb484-5"><a href="modeling.html#cb484-5"></a><span class="kw">rownames</span>(ipa_tab) =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb484-6"><a href="modeling.html#cb484-6"></a></span>
<span id="cb484-7"><a href="modeling.html#cb484-7"></a><span class="kw">cat</span>(<span class="kw">kable</span>(ipa_tab, <span class="dt">digits =</span> <span class="dv">4</span>, <span class="dt">format =</span> <span class="st">&quot;latex&quot;</span>, <span class="dt">booktabs =</span> <span class="ot">TRUE</span>,</span>
<span id="cb484-8"><a href="modeling.html#cb484-8"></a>          <span class="dt">label =</span> <span class="st">&quot;cvsl-ipa&quot;</span>,</span>
<span id="cb484-9"><a href="modeling.html#cb484-9"></a>          <span class="dt">row.names =</span> <span class="ot">FALSE</span>,</span>
<span id="cb484-10"><a href="modeling.html#cb484-10"></a>          <span class="dt">caption =</span> <span class="st">&quot;Cross-validated index of prediction accuracy for each learner and the ensemble&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb484-11"><a href="modeling.html#cb484-11"></a><span class="st">      </span><span class="kw">kable_styling</span>(<span class="dt">latex_options =</span> <span class="st">&quot;hold_position&quot;</span>),</span>
<span id="cb484-12"><a href="modeling.html#cb484-12"></a>      <span class="dt">file =</span> <span class="st">&quot;tables/cvsl-ipa-table.tex&quot;</span>)</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="exploratory-data-analysis.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="calibration.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
